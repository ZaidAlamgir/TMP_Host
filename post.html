<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Your Thoughts</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="menu.css">
    <link rel="stylesheet" href="login.css">
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; }
        .post-container { max-width: 680px; margin: 20px auto; background-color: #fff; border-radius: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 25px; }
        h1, h2 { text-align: center; color: #1c1e21; margin-bottom: 20px; }
        #postForm textarea { width: 100%; height: 120px; border: 1px solid #dddfe2; border-radius: 10px; padding: 12px; font-size: 16px; resize: none; margin-bottom: 10px; }
        #postForm textarea:focus { outline: none; border-color: #0073e6; }
        #charCounter { text-align: right; font-size: 14px; color: #606770; margin-bottom: 15px; }
        #submitPost { width: 100%; padding: 12px; background: linear-gradient(135deg, #0073e6, #005bb5); color: #fff; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #submitPost:disabled { background: #9dbfd9; cursor: not-allowed; }
        .loader { display: none; margin: 20px auto; border: 5px solid #f3f3f3; border-top: 5px solid #0073e6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .user-post { background-color: #fff; border: 1px solid #dddfe2; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .user-post p { font-size: 16px; line-height: 1.5; color: #1c1e21; white-space: pre-wrap; word-wrap: break-word; }
        
        .post-meta { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 10px; }
        .post-author-details { text-align: left; }
        .post-author { font-size: 14px; color: #1c1e21; font-weight: bold; }
        .post-qualification { font-size: 13px; color: #606770; }
        .post-timestamp { font-size: 12px; color: #606770; text-align: right; flex-shrink: 0; }

        .user-info-header { display: flex; align-items: center; margin-bottom: 20px; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; font-weight: bold; margin-right: 15px; }
        .user-details strong { display: block; font-size: 16px; color: #1c1e21; }
        .login-prompt { text-align: center; padding: 20px; font-size: 16px; }
        .login-prompt a { color: #0073e6; text-decoration: none; font-weight: bold; }
        .form-group { text-align: left; margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 15px; color: #606770; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #dddfe2; border-radius: 10px; font-size: 16px; box-sizing: border-box;}
        
        #endOfFeedMessage { text-align: center; color: #8a8d91; padding: 20px; display: none; font-style: italic; }

        /* --- Word Suggestion Styles --- */
        .suggestions-container { position: relative; }
        #suggestion-loader { font-size: 14px; color: #606770; text-align: center; padding: 10px; background-color: #f0f2f5; border-radius: 8px; margin-top: -10px; margin-bottom: 10px; display: none; }
        #suggestions-box { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0; min-height: 38px; }
        .suggestion-chip { background-color: #e7f3ff; color: #0073e6; padding: 8px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: background-color 0.2s; }
        .suggestion-chip:hover { background-color: #cfe7ff; }

        @media (max-width: 768px) {
            body { padding-bottom: 60px; }
            .post-container { margin: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }
            #postForm textarea { font-size: 15px; height: 100px; }
            #submitPost { font-size: 16px; padding: 12px; }
            .user-avatar { width: 40px; height: 40px; font-size: 1.5rem; margin-right: 10px; }
            .user-details strong { font-size: 15px; }
        }
    </style>
</head>
<body>

<div id="header-placeholder"></div>

<main>
    <div class="post-container">
        <div id="userInfoContainer" style="display: none;">
            <div class="user-info-header">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-details">
                    <strong id="userName"></strong>
                </div>
            </div>
            <form id="postForm">
                <div class="form-group">
                    <label for="authorQualification">Your Qualification (e.g., Student, Researcher)</label>
                    <input type="text" id="authorQualification" placeholder="This will be displayed with your name" required>
                </div>
                <div class="suggestions-container">
                    <textarea id="postContent" placeholder="What's on your mind?" required></textarea>
                    <div id="suggestion-loader">Loading smart suggestions...</div>
                    <div id="suggestions-box"></div>
                </div>
                <div id="charCounter">1000 words remaining</div>
                <button type="submit" id="submitPost">Post</button>
            </form>
        </div>
        <div class="login-prompt" id="loginPromptContainer" style="display: none;">
            <p><a href="auth.html">Log in</a> or <a href="auth.html">sign up</a> to share your thoughts.</p>
        </div>
        <div class="loader" id="postSubmitLoader"></div>
    </div>
    <div class="post-container">
        <h2>Recent Posts</h2>
        <div id="postsFeed"></div>
        <div id="postsLoader" class="loader" style="display: none; margin-top: 20px;"></div>
        <div id="endOfFeedMessage">You've reached the end!</div>
        <div id="scrollSentinel" style="height: 50px;"></div>
    </div>
</main>

<div id="bottom-nav-placeholder"></div>

<!-- External Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<!-- NEW: TensorFlow.js for on-device AI -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>

<!-- Your App Scripts -->
<script src="firebase-init.js"></script>
<script src="header-injector.js"></script>
<script src="bottom-nav.js"></script>

<script>
    // --- Word Suggester Class (Upgraded with fixes and more suggestions) ---
    class WordSuggester {
        constructor(textareaId, suggestionsBoxId, loaderId) {
            this.textarea = document.getElementById(textareaId);
            this.suggestionsBox = document.getElementById(suggestionsBoxId);
            this.loader = document.getElementById(loaderId);
            this.model = null;
            this.dictionary = new Set();
            this.isReady = false;
            this.debounceTimeout = null;
            this.commonNextWords = ['the', 'a', 'is', 'in', 'and', 'with', 'for', 'to', 'that', 'it', 'on', 'as', 'of', 'at', 'by', 'was', 'are', 'from', 'has', 'have', 'an', 'be', 'not', 'this', 'but'];
        }

        async init() {
            this.loader.style.display = 'block';
            try {
                const dictionary = await fetch('https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt')
                    .then(res => res.text())
                    .then(text => new Set(text.split('\n')));
                
                this.dictionary = dictionary;
                this.isReady = true;
                this.loader.style.display = 'none';
                console.log("Word Suggester is ready.");
                this.textarea.addEventListener('input', () => this.onInput());
            } catch (error) {
                console.error("Failed to initialize Word Suggester:", error);
                this.loader.textContent = "Could not load suggestions.";
            }
        }

        onInput() {
            clearTimeout(this.debounceTimeout);
            this.debounceTimeout = setTimeout(() => {
                this.generateSuggestions();
            }, 150);
        }

        generateSuggestions() {
            if (!this.isReady || !this.textarea.value) {
                this.suggestionsBox.innerHTML = '';
                return;
            }

            const text = this.textarea.value;
            const lastChar = text.slice(-1);

            if (lastChar === ' ') {
                const shuffled = this.commonNextWords.sort(() => 0.5 - Math.random());
                this.displaySuggestions(shuffled.slice(0, 7), 'predict');
            } else {
                const lastWord = text.trim().split(/\s+/).pop();
                if (lastWord.length < 2) {
                    this.suggestionsBox.innerHTML = '';
                    return;
                }
                let completions = [];
                for (const word of this.dictionary) {
                    if (word.startsWith(lastWord.toLowerCase())) {
                        completions.push(word);
                        if (completions.length >= 50) break;
                    }
                }
                this.displaySuggestions(completions.slice(0, 7), 'complete');
            }
        }

        displaySuggestions(words, type) {
            this.suggestionsBox.innerHTML = '';
            words.forEach(word => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = word;
                chip.onclick = () => this.applySuggestion(word, type);
                this.suggestionsBox.appendChild(chip);
            });
        }

        // --- FINAL, ROBUST CURSOR LOGIC ---
        applySuggestion(word, type) {
            const ta = this.textarea;
            const cursorPosition = ta.selectionStart;

            ta.focus();

            if (type === 'complete') {
                const textBeforeCursor = ta.value.substring(0, cursorPosition);
                // This is a reliable way to find the start of the last word
                const startOfWord = textBeforeCursor.lastIndexOf(' ') + 1;
                
                // Replace the partial word with the full one and a space.
                // The 'end' mode automatically places the cursor after the inserted text.
                ta.setRangeText(word + ' ', startOfWord, cursorPosition, 'end');

            } else { // 'predict'
                const textBeforeCursor = ta.value.substring(0, cursorPosition);
                
                // Ensure there's exactly one space before the predicted word.
                const textToInsert = (textBeforeCursor.endsWith(' ') || textBeforeCursor.length === 0) 
                                   ? word + ' ' 
                                   : ' ' + word + ' ';
                
                // Insert the new word right at the cursor.
                ta.setRangeText(textToInsert, cursorPosition, cursorPosition, 'end');
            }
            
            // Trigger the input event to update the word counter
            ta.dispatchEvent(new Event('input', { bubbles: true }));
            this.suggestionsBox.innerHTML = '';
        }
    }


    // --- Existing Page Logic ---
    let nextPostOffset = 0;
    let isLoading = false;
    let hasMorePosts = true;
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxJ1O0ePZl6RUqGkJVIvLtlnFcE8-3czLoSu7wFVoN0jeImOhfde-7L6QZsqZ0cJTxy/exec";
    
    function generateColorForUser(userId) {
        const colors = ['#e53935', '#d81b60', '#8e24aa', '#5e35b1', '#3949ab', '#1e88e5', '#039be5', '#00acc1', '#00897b', '#43a047', '#fb8c00', '#f4511e', '#6d4c41', '#546e7a'];
        let hash = 0;
        if (!userId || userId.length === 0) return colors[0];
        for (let i = 0; i < userId.length; i++) {
            const char = userId.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0;
        }
        return colors[Math.abs(hash % colors.length)];
    }
    
    function renderPosts(posts, clearExisting = false) {
        const postsFeed = document.getElementById('postsFeed');
        if(clearExisting) postsFeed.innerHTML = '';
        if (!posts || posts.length === 0) {
            if (nextPostOffset === 0) {
                 postsFeed.innerHTML = "<p>No posts yet. Be the first to share!</p>";
            }
            return;
        }
        posts.forEach(post => {
            const postElement = document.createElement('div');
            postElement.className = 'user-post';
            postElement.innerHTML = `<p>${post.content}</p><div class="post-meta"><div class="post-author-details"><div class="post-author">${post.authorName || 'Anonymous'}</div><div class="post-qualification">${post.authorQualification || ''}</div></div><div class="post-timestamp">${new Date(post.timestamp).toLocaleString()}</div></div>`;
            postsFeed.appendChild(postElement);
        });
    }

    async function fetchPosts(offset, limit) {
        if (isLoading || !hasMorePosts) return;
        isLoading = true;
        document.getElementById('postsLoader').style.display = 'block';
        document.getElementById('endOfFeedMessage').style.display = 'none';
        try {
            const response = await fetch(`${SCRIPT_URL}?offset=${offset}&limit=${limit}`);
            const data = await response.json();
            if (data.error) throw new Error(data.message);
            renderPosts(data.posts, offset === 0);
            nextPostOffset = offset + (data.posts ? data.posts.length : 0);
            hasMorePosts = data.hasMore;
            if (!hasMorePosts && nextPostOffset > 0) {
                document.getElementById('endOfFeedMessage').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading posts:', error);
            if (offset === 0) document.getElementById('postsFeed').innerHTML = `<p style="color: red;">Could not load posts. Details: ${error.message}</p>`;
        } finally {
            isLoading = false;
            document.getElementById('postsLoader').style.display = 'none';
        }
    }
    
    async function initializePage() {
        const user = await authReady; 
        if (user) {
            setupPostingInterface(user);
        } else {
            document.getElementById('loginPromptContainer').style.display = 'block';
        }
        await fetchPosts(0, 5);
        setupInfiniteScroll();
    }
    
    function resetAndReloadFeed() {
        localStorage.clear();
        document.getElementById('postsFeed').innerHTML = '';
        nextPostOffset = 0;
        hasMorePosts = true;
        document.getElementById('endOfFeedMessage').style.display = 'none';
        initializePage();
    }

    function setupPostingInterface(user) {
        document.getElementById('userInfoContainer').style.display = 'block';
        document.getElementById('userName').textContent = user.displayName || 'Anonymous User';
        const avatar = document.getElementById('userAvatar');
        avatar.textContent = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
        avatar.style.backgroundColor = generateColorForUser(user.uid);
        
        const suggester = new WordSuggester('postContent', 'suggestions-box', 'suggestion-loader');
        suggester.init();

        const postForm = document.getElementById('postForm');
        postForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submitPost');
            const postSubmitLoader = document.getElementById('postSubmitLoader');
            const qualificationInput = document.getElementById('authorQualification');
            const postContent = document.getElementById('postContent');
            
            if(!qualificationInput.value.trim() || !postContent.value.trim()){
                alert("Please fill out both your qualification and your post content.");
                return;
            }

            submitButton.disabled = true;
            postSubmitLoader.style.display = 'block';
            const formData = new FormData();
            formData.append('post', postContent.value);
            formData.append('authorName', user.displayName || 'Anonymous');
            formData.append('authorQualification', qualificationInput.value);
            
            fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    postContent.value = '';
                    qualificationInput.value = '';
                    document.getElementById('charCounter').textContent = '1000 words remaining';
                    resetAndReloadFeed();
                } else { throw new Error(data.message || 'An unknown error occurred.'); }
            })
            .catch(error => {
                console.error('Error submitting post:', error);
                alert('An error occurred. Details: ' + error.message);
            })
            .finally(() => {
                postSubmitLoader.style.display = 'none';
                submitButton.disabled = false;
            });
        });
        
        // --- NEW: Word Counting Logic ---
        const postContent = document.getElementById('postContent');
        const charCounter = document.getElementById('charCounter');
        const submitButton = document.getElementById('submitPost');
        const WORD_LIMIT = 1000;

        postContent.addEventListener('input', () => {
            const text = postContent.value.trim();
            const words = text === '' ? [] : text.split(/\s+/);
            const wordCount = words.length;
            const remaining = WORD_LIMIT - wordCount;

            if (remaining >= 0) {
                charCounter.textContent = `${remaining} words remaining`;
                charCounter.style.color = '#606770';
                submitButton.disabled = false;
            } else {
                charCounter.textContent = `${Math.abs(remaining)} words over limit`;
                charCounter.style.color = 'red';
                submitButton.disabled = true;
            }
        });
    }

    function setupInfiniteScroll() {
        const sentinel = document.getElementById('scrollSentinel');
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && hasMorePosts && !isLoading) {
                fetchPosts(nextPostOffset, 5);
            }
        }, { rootMargin: '0px 0px 300px 0px' });
        observer.observe(sentinel);
    }
    
    document.addEventListener('DOMContentLoaded', initializePage);
</script>

</body>
</html>


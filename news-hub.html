<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Hub</title>
    <link rel="stylesheet" href="assets/style/style.css">
    <link rel="stylesheet" href="assets/style/header.css">
    <link rel="stylesheet" href="assets/style/index-menu.css">
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; }
        .main-container { max-width: 900px; margin: 20px auto; padding: 20px; }
        .page-header { text-align: center; margin-bottom: 2rem; }
        .page-header h1 { font-size: 2.5rem; font-weight: bold; color: #1c1e21; }
        .page-header .tag-highlight { color: #0073e6; }
        .loader { display: block; margin: 40px auto; border: 5px solid #f3f3f3; border-top: 5px solid #0073e6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Article Card Styles */
        .articles-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .article-card {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .article-card-image { width: 100%; height: 200px; object-fit: cover; }
        .article-card-content { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .article-card-content h3 { font-size: 1.4rem; font-weight: bold; margin-bottom: 0.5rem; color: #1c1e21; }
        .article-card-content p { font-size: 1rem; line-height: 1.6; color: #606770; margin-bottom: 1rem; flex-grow: 1; }
        .article-card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #8a8d91; border-top: 1px solid #f0f2f5; padding-top: 1rem; margin-top: auto; }

        @media (min-width: 768px) {
            .articles-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div id="header-placeholder"></div>

<main class="main-container">
    <div class="page-header">
        <h1 id="page-title">Loading News...</h1>
    </div>
    <div id="articles-container" class="articles-grid">
        <div id="loader" class="loader"></div>
    </div>
</main>

<div id="bottom-nav-placeholder"></div>

<script src="assets/header-injector.js"></script>
<script src="assets/bottom-nav.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const GITHUB_CONFIG = {
        repoOwner: 'zaidalamgir',
        repoName: 'TMP_Host',
        articlesPath: '_posts'
    };

    const articlesContainer = document.getElementById('articles-container');
    const pageTitle = document.getElementById('page-title');
    const loader = document.getElementById('loader');

    // 1. Get the tag from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const tagFilter = urlParams.get('tag');

    if (!tagFilter) {
        pageTitle.textContent = 'No Category Specified';
        loader.style.display = 'none';
        articlesContainer.innerHTML = '<p>Please select a category from the homepage.</p>';
        return;
    }

    // Update the page title with the selected tag
    const formattedTag = tagFilter.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    pageTitle.innerHTML = `News in <span class="tag-highlight">${formattedTag}</span>`;

    // 2. Fetch and filter articles
    async function loadArticles() {
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.repoOwner}/${GITHUB_CONFIG.repoName}/contents/${GITHUB_CONFIG.articlesPath}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`GitHub API error: ${response.statusText}`);
            
            const files = await response.json();
            if (!Array.isArray(files)) {
                throw new Error("No articles found in the repository path.");
            }

            const articlePromises = files.map(file => 
                fetch(file.download_url)
                    .then(res => res.text())
                    .then(text => parseFrontmatter(text, file.html_url))
            );

            const allArticles = await Promise.all(articlePromises);

            // Filter articles that include the specified tag
            const filteredArticles = allArticles
                .filter(article => article && article.tags && article.tags.includes(tagFilter))
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by newest first

            renderArticles(filteredArticles);

        } catch (error) {
            console.error('Error loading articles:', error);
            articlesContainer.innerHTML = `<p style="color: red;">Could not load articles. ${error.message}</p>`;
        } finally {
            loader.style.display = 'none';
        }
    }

    // 3. Helper to parse frontmatter from Markdown
    function parseFrontmatter(text, html_url) {
        const frontmatterMatch = text.match(/---([\s\S]*?)---/);
        if (!frontmatterMatch) return null;

        const article = { html_url };
        const frontmatter = frontmatterMatch[1];
        
        frontmatter.split('\n').forEach(line => {
            const parts = line.split(':');
            if (parts.length >= 2) {
                const key = parts[0].trim();
                let value = parts.slice(1).join(':').trim();

                // Clean up value and parse tags array
                if (key === 'tags') {
                    article[key] = value.replace(/[\[\]"]/g, '').split(',').map(t => t.trim());
                } else {
                    article[key] = value.replace(/"/g, '');
                }
            }
        });

        // Add a snippet of the content
        const body = text.substring(frontmatterMatch[0].length).trim();
        article.snippet = body.split('\n\n')[0].replace(/[#>!*]/g, '').substring(0, 150) + '...';

        return article;
    }

    // 4. Render the filtered articles
    function renderArticles(articles) {
        if (articles.length === 0) {
            articlesContainer.innerHTML = `<p>No articles found for the category "${formattedTag}".</p>`;
            return;
        }

        articlesContainer.innerHTML = ''; // Clear loader
        articles.forEach(article => {
            const card = document.createElement('a');
            card.className = 'article-card';
            // Link to the actual post page, which Jekyll generates
            const postUrl = article.html_url.replace('github.com', 'zaidalamgir.github.io').replace('/blob/', '/');
            card.href = postUrl;

            const placeholderImage = `https://placehold.co/600x400/3498db/ffffff?text=${encodeURIComponent(article.title || 'Article')}`;

            card.innerHTML = `
                <img src="${article.image || placeholderImage}" alt="${article.title}" class="article-card-image">
                <div class="article-card-content">
                    <h3>${article.title || 'Untitled Article'}</h3>
                    <p>${article.subheadline || article.snippet}</p>
                    <div class="article-card-meta">
                        <span>By ${article.author || 'Staff Writer'}</span>
                        <span>${new Date(article.date).toLocaleDateString()}</span>
                    </div>
                </div>
            `;
            articlesContainer.appendChild(card);
        });
    }

    loadArticles();
});
</script>

</body>
</html>
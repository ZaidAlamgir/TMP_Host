<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORG CMS - Professional Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden { display: none; }
        
        /* Glass Panel & General UI */
        .glass-panel { background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        /* --- UPDATED BLOCK STYLES --- */
        .dynamic-content-block {
            border: 1px solid #e2e8f0; border-radius: 0.75rem; 
            padding: 3.5rem 1.25rem 1.5rem 1.25rem; margin-top: 1.5rem; background-color: #ffffff; position: relative; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s ease;
        }
        .dynamic-content-block:hover { border-color: #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }

        /* Drag Handle */
        .drag-handle { position: absolute; top: 0; left: 0; width: 100%; height: 2.5rem; display: flex; 
            align-items: center; justify-content: center;
            cursor: grab; color: #94a3b8; 
            background-color: #f8fafc; border-bottom: 1px solid #e2e8f0;
            border-radius: 0.75rem 0.75rem 0 0; z-index: 10;
        }
        .drag-handle:hover { background-color: #f1f5f9; color: #64748b; cursor: grabbing; }

        /* Delete Button */
        .remove-block-btn { 
            position: absolute; top: 1.25rem; transform: translateY(-50%); right: 0.75rem; 
            width: 1.75rem; height: 1.75rem; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            padding: 0; margin: 0; line-height: 1; color: #ef4444; cursor: pointer; transition: all 0.2s; z-index: 20; 
        }
        .remove-block-btn:hover { background-color: #fee2e2; }
        .sortable-ghost { opacity: 0.4; background: #f8fafc; border: 2px dashed #cbd5e1; }

        /* Chips */
        .tag-suggestions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
        .tag-chip, .category-chip, .country-chip {
            font-size: 0.75rem; font-weight: 600; padding: 0.35rem 0.85rem;
            border-radius: 9999px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .tag-chip { background-color: #f1f5f9; color: #475569; }
        .tag-chip:hover { background-color: #e2e8f0; transform: translateY(-1px); }
        .category-chip { background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        .category-chip:hover { background-color: #dbeafe; transform: translateY(-1px); }
        .country-chip { background-color: #ecfdf5; color: #047857; border-color: #6ee7b7; }
        .country-chip:hover { background-color: #d1fae5; transform: translateY(-1px); }
        .country-list-scroll { max-height: 220px; overflow-y: auto; padding: 4px; border: 1px solid #f1f5f9; background: #f8fafc; border-radius: 0.5rem; }

        /* Inputs */
        textarea, input, select { transition: border-color 0.2s, box-shadow 0.2s; outline: none; }
        textarea:focus, input:focus, select:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        /* Modals */
        .link-modal-overlay, .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.4); z-index: 1000; backdrop-filter: blur(2px);
            display: flex; justify-content: center; align-items: flex-start; padding-top: 15vh;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
        }
        .link-modal-overlay.visible, .modal-overlay.visible { opacity: 1; pointer-events: all; }
        .link-modal-content, .modal-content {
            background-color: white; padding: 2rem; border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%; max-width: 500px;
            transform: scale(0.95); transition: transform 0.2s ease;
        }
        .link-modal-overlay.visible .link-modal-content, .modal-overlay.visible .modal-content { transform: scale(1); }
        .link-modal-input {
            width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem;
            font-size: 1rem; margin-bottom: 1.5rem;
        }
        .link-modal-buttons { display: flex; justify-content: flex-end; gap: 0.75rem; }
        .link-modal-btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; transition: opacity 0.2s;}
        .link-modal-btn:hover { opacity: 0.9; }
        .link-modal-btn.primary { background-color: #4f46e5; color: white; }
        .link-modal-btn.secondary { background-color: #f3f4f6; color: #374151; }

        /* --- TABLE FEATURE STYLES --- */
        .table-wrapper { 
            overflow-x: auto; background: white; border: 1px solid #e2e8f0; 
            border-radius: 0.5rem; margin-top: 10px; max-width: 100%; 
        }
        .sheet-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .sheet-table th, .sheet-table td { border: 1px solid #e2e8f0; padding: 0; vertical-align: top; position: relative; }
        .sheet-table thead td { background-color: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        
        .sheet-cell { 
            width: 100%; outline: none; padding: 12px; min-height: 44px; 
            font-size: 0.9rem; color: #334155; cursor: text;
        }
        .sheet-cell:focus { background-color: rgba(99, 102, 241, 0.05); box-shadow: inset 0 0 0 2px #6366f1; }
        .sheet-cell:empty:before { content: attr(data-placeholder); color: #94a3b8; }
        .sheet-table thead .sheet-cell { font-weight: 700; color: #1e293b; text-align: center; }
        
        /* Table Toolbar */
        .table-toolbar-container { background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0; margin-bottom: 10px; padding: 4px; }
        .table-toolbar-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; padding: 4px; }
        .table-toolbar-row:not(:last-child) { border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 4px; }
        .table-tool-group { display: flex; gap: 2px; border-right: 1px solid #cbd5e1; padding-right: 6px; margin-right: 2px; }
        .table-tool-group:last-child { border-right: none; }
        
        .tool-btn { 
            padding: 6px 8px; border-radius: 4px; border: 1px solid transparent; 
            cursor: pointer; color: #475569; font-size: 0.8rem; background: white; border-color: #cbd5e1;
            display: flex; align-items: center; gap: 4px;
        }
        .tool-btn:hover:not(:disabled) { background: #e2e8f0; color: #1e293b; }
        .tool-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #f1f5f9; }
        
        .color-picker-wrapper { position: relative; display: flex; align-items: center; }
        input[type="color"] { width: 28px; height: 28px; padding: 0; border: none; background: none; cursor: pointer; }
        
        /* Table Settings */
        .table-settings-container { margin-top: 10px; padding: 12px; background: #f1f5f9; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
        .table-caption-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem; background: white; display: block; }
        .table-footer-options { display: flex; gap: 15px; align-items: center; font-size: 0.85rem; color: #64748b; }
        .section-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-right: 4px; }
        
        /* Auto-save Indicator */
        .save-indicator {
            position: fixed; bottom: 20px; right: 20px; background: #ffffff;
            padding: 8px 16px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0; font-size: 0.75rem; font-weight: 600;
            color: #64748b; opacity: 0; transition: opacity 0.3s; z-index: 100;
        }
        .save-indicator.visible { opacity: 1; }
    </style>
</head>
<body class="text-slate-800 min-h-screen">

    <div id="save-indicator" class="save-indicator"><i class="fas fa-check-circle text-emerald-500 mr-2"></i>Draft Saved Locally</div>

    <div id="app" class="w-full max-w-5xl mx-auto p-4 sm:p-6 md:p-8">

        <div id="login-view" class="glass-panel p-10 rounded-2xl max-w-md mx-auto mt-20 text-center">
             <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl text-slate-700">
                <i class="fas fa-newspaper"></i>
             </div>
             <h1 class="text-3xl font-extrabold mb-3 text-slate-900">News CMS Login</h1>
             <p class="text-slate-500 mb-8 leading-relaxed">Secure access for Organization Members.<br>Please authenticate to continue.</p>
             <button id="login-button" class="bg-[#24292e] text-white font-bold py-3.5 px-6 rounded-xl hover:bg-[#1b1f23] transition-all transform hover:scale-[1.02] flex items-center justify-center w-full shadow-lg">
                 <i class="fab fa-github mr-3 text-xl"></i>
                 Sign in with GitHub
             </button>
        </div>

        <div id="editor-view" class="hidden glass-panel p-6 sm:p-10 rounded-2xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-slate-100 pb-6">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Create News Article</h1>
                    <p class="text-sm text-slate-500 mt-1">Drafting for <span class="font-semibold text-indigo-600">TheMuslimPost Organization</span></p>
                </div>
                <button id="logout-button" class="mt-4 md:mt-0 text-sm text-slate-400 hover:text-red-500 font-medium transition-colors flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <div class="mb-8 p-5 bg-slate-50 rounded-xl border border-slate-200">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                        <i class="fas fa-folder-tree"></i>
                    </div>
                    <div>
                        <label for="target-repo-select" class="block text-sm font-bold text-slate-800">Target Repository</label>
                        <p class="text-xs text-slate-500">Choose where this article will be stored within the organization.</p>
                    </div>
                </div>
                <div class="relative">
                    <select id="target-repo-select" class="w-full p-3 pl-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm appearance-none cursor-pointer font-medium text-slate-700 shadow-sm">
                        <optgroup label="New Categories (Organization: TheMuslimPost)">
                            <option value="tmp-articles-world-politics">World Politics</option>
                            <option value="tmp-articles-indian-politics">Indian Politics</option>
                            <option value="tmp-articles-muslim-world">Muslim World</option>
                            <option value="tmp-articles-technology">Technology</option>
                            <option value="tmp-articles-medical-science">Medical Science</option>
                            <option value="tmp-articles-global-economy">Global Economy</option>
                            <option value="tmp-articles-art-culture">Art & Culture</option>
                            <option value="tmp-articles-weather">Weather</option>
                            <option value="tmp-articles-sports">Sports</option>
                            <option value="tmp-articles-national-news">National News</option>
                            <option value="tmp-articles-international-news">International News</option>
                        </optgroup>
                        <optgroup label="Legacy (Owner: zaidalamgir)">
                            <option value="TMP_Host">Main Site (TMP_Host)</option>
                        </optgroup>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <label for="article-headline" class="block text-xs font-bold uppercase tracking-wider text-slate-400 mb-1">Headline</label>
                    <textarea id="article-headline" rows="1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-bold text-xl md:text-2xl leading-normal text-slate-900 placeholder-slate-400" placeholder="The main title of the article"></textarea>
                </div>
                <div>
                    <label for="article-subheadline" class="block text-xs font-bold uppercase tracking-wider text-slate-400 mb-1">Subheadline</label>
                    <textarea id="article-subheadline" rows="1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base md:text-lg leading-normal text-slate-600 placeholder-slate-400" placeholder="A brief, engaging summary"></textarea>
                </div>
            </div>

             <hr class="my-8 border-slate-100">

             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                 <div>
                    <label for="article-main-image-url" class="block text-sm font-medium text-slate-700 mb-1">Main Image URL</label>
                    <div class="relative">
                        <i class="fas fa-image absolute left-3 top-3 text-slate-400"></i>
                        <input type="text" id="article-main-image-url" class="w-full p-2.5 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="https://media.tmpnews.com/images/...">
                    </div>
                 </div>
                 <div>
                    <label for="article-author" class="block text-sm font-medium text-slate-700 mb-1">Author Name</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-3 top-3 text-slate-400"></i>
                        <input type="text" id="article-author" class="w-full p-2.5 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" value="TMP Staff">
                    </div>
                 </div>
             </div>
             
             <div class="mb-8">
                <label for="article-main-image-desc" class="block text-sm font-medium text-slate-700 mb-1">Main Image Alt Text</label>
                <textarea id="article-main-image-desc" rows="2" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm placeholder-slate-400 leading-normal" placeholder="A short description of the main image (for accessibility)"></textarea>
             </div>

             <hr class="my-8 border-slate-100">

             <div class="mb-4">
                <label for="article-p1" class="block text-sm font-bold text-slate-800 mb-2">Article Content (Start)</label>
                <textarea id="article-p1" rows="6" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 leading-relaxed text-slate-700 placeholder-slate-400" placeholder="The first paragraph of your article..."></textarea>
             </div>

             <div id="dynamic-content-blocks"></div>

             <div class="my-8 p-6 bg-slate-50 rounded-xl border border-dashed border-slate-300 flex flex-col sm:flex-row items-center justify-center gap-4">
                 <select id="block-type-select" class="p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm min-w-[200px]">
                    <option value="paragraph">Paragraph</option>
                    <option value="table">Table (Pro Spreadsheet)</option>
                    <option value="headline-h2">Headline (H2)</option>
                    <option value="headline-h3">Headline (H3)</option>
                    <option value="headline-h4">Headline (H4)</option>
                    <option value="image">Image</option>
                    <option value="quote">Quote</option>
                    <optgroup label="Social Media Embeds">
                        <option value="twitter">Twitter</option>
                        <option value="twitter-video">Twitter (Video)</option>
                        <option value="instagram">Instagram</option>
                        <option value="instagram-video">Instagram (Video Only)</option>
                        <option value="facebook">Facebook</option>
                        <option value="tiktok">TikTok</option>
                        <option value="youtube">YouTube</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="reddit">Reddit</option>
                        <option value="telegram">Telegram</option>
                    </optgroup>
                 </select>
                 <button id="add-block-button" class="bg-slate-800 text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-slate-700 transition-colors shadow-sm flex items-center">
                     <i class="fas fa-plus mr-2"></i> Add Block
                 </button>
             </div>

             <hr class="my-8 border-slate-100">

             <div class="mb-6">
                <label for="article-tags" class="block text-sm font-medium text-slate-700 mb-1">Tags</label>
                <input type="text" id="article-tags" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., technology, politics (comma-separated)">
                <div id="tag-suggestions-container" class="tag-suggestions">
                    <div class="tag-chip" data-tag="breaking-news">Breaking News</div>
                    <div class="tag-chip" data-tag="analysis">Analysis</div>
                    <div class="tag-chip" data-tag="opinion">Opinion</div>
                    <div class="tag-chip" data-tag="updates">Updates</div>
                </div>
             </div>

             <div class="mb-8 p-5 bg-blue-50 rounded-xl border border-blue-100">
                <label class="block text-sm font-bold text-blue-900 mb-1">Categories (Required for URL)</label>
                <p class="text-xs text-blue-600 mb-3">Select at least one category to ensure the link works correctly.</p>
                <input type="text" id="article-categories" class="w-full p-2.5 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white mb-4" placeholder="Selected categories will appear here...">
                
                <div class="mb-2">
                    <p class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">General Topics</p>
                    <div id="category-suggestions-container" class="tag-suggestions">
                        <div class="category-chip" data-cat="world-politics">World Politics</div>
                        <div class="category-chip" data-cat="indian-politics">Indian Politics</div>
                        <div class="category-chip" data-cat="muslim-world">Muslim World</div>
                        <div class="category-chip" data-cat="technology">Technology</div>
                        <div class="category-chip" data-cat="medical-science">Medical Science</div>
                        <div class="category-chip" data-cat="global-economy">Global Economy</div>
                        <div class="category-chip" data-cat="art-culture">Art & Culture</div>
                        <div class="category-chip" data-cat="weather">Weather</div>
                        <div class="category-chip" data-cat="sports">Sports</div>
                        <div class="category-chip" data-cat="national-news">National News</div>
                        <div class="category-chip" data-cat="international-news">International News</div>
                        <div class="category-chip" data-cat="finance">Finance</div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-blue-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2">
                        <p class="text-xs font-bold text-emerald-600 uppercase tracking-wider">OIC Member Countries (57)</p>
                        <div class="relative w-full sm:w-1/2">
                            <i class="fas fa-search absolute left-3 top-2.5 text-emerald-400 text-xs"></i>
                            <input type="text" id="country-search-input" class="w-full pl-8 p-2 text-xs border border-emerald-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Search country to add...">
                        </div>
                    </div>
                    <div id="country-suggestions-container" class="tag-suggestions country-list-scroll"></div>
                </div>
             </div>

             <button id="publish-button" class="bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-500 transition-all shadow-lg hover:shadow-indigo-500/30 w-full flex items-center justify-center text-lg">
                 <span id="publish-text">Publish Article</span>
                 <span id="publish-spinner" class="hidden">
                     <i class="fas fa-spinner fa-spin mr-2"></i> Publishing...
                 </span>
             </button>
             <p id="status-message" class="text-center mt-4 text-sm font-medium"></p>
        </div>
    </div>

    <div id="link-modal" class="link-modal-overlay">
        <div class="link-modal-content">
             <h3 class="text-xl font-bold mb-4 text-slate-800">Add or Edit Link</h3>
             <input type="text" id="link-url-input" class="link-modal-input" placeholder="https://example.com">
             <div class="link-modal-buttons">
                 <button id="cancel-link-btn" class="link-modal-btn secondary">Cancel</button>
                 <button id="add-link-btn" class="link-modal-btn primary">Add Link</button>
             </div>
        </div>
    </div>

    <div id="paste-modal" class="modal-overlay">
        <div class="modal-content">
             <h3 class="text-xl font-bold mb-2">Import Table Data</h3>
             <p class="text-xs text-slate-500 mb-4">Paste from Excel (Tabs) OR Pipe Separated Values (e.g. Item | Cost | Desc)</p>
             <textarea id="paste-input" class="w-full h-32 border p-2 rounded mb-4 text-xs font-mono" placeholder="Paste data here..."></textarea>
             <div class="link-modal-buttons">
                 <button onclick="document.getElementById('paste-modal').classList.remove('visible')" class="link-modal-btn secondary">Cancel</button>
                 <button id="confirm-paste-btn" class="link-modal-btn primary">Import</button>
             </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIG & DATA
        // ==========================================
        const GITHUB_CONFIG = {
            clientId: 'Ov23lissjbf3KA3blXGg',
            redirectUri: 'https://www.tmpnews.com/auth-callback.html',
            orgOwner: 'TheMuslimPost',
            legacyOwner: 'zaidalamgir',
            repoBranch: 'main',
            tokenExchangeUrl: 'https://github-auth-proxy-org.zaidkhan137782.workers.dev',
            // NEW: Notification Configuration
            notifyOwner: 'ZaidAlamgir',
            notifyRepo: 'TMPnews_notify'
        };

        const oicCountriesList = [
            "Afghanistan", "Albania", "Algeria", "Azerbaijan", "Bahrain", "Bangladesh", "Benin", 
            "Brunei", "Burkina Faso", "Cameroon", "Chad", "Comoros", "CÃ´te d'Ivoire", "Djibouti", 
            "Egypt", "Gabon", "Gambia", "Guinea", "Guinea-Bissau", "Guyana", "Indonesia", "Iran", 
            "Iraq", "Jordan", "Kazakhstan", "Kuwait", "Kyrgyzstan", "Lebanon", "Libya", "Malaysia", 
            "Maldives", "Mali", "Mauritania", "Morocco", "Mozambique", "Niger", "Nigeria", "Oman", 
            "Pakistan", "Palestine", "Qatar", "Saudi Arabia", "Senegal", "Sierra Leone", "Somalia", 
            "Sudan", "Suriname", "Syria", "Tajikistan", "Togo", "Tunisia", "Turkey", "Turkmenistan", 
            "Uganda", "United Arab Emirates", "Uzbekistan", "Yemen", "Kosovo"
        ];
        
        // --- ELEMENTS ---
        const loginView = document.getElementById('login-view'), editorView = document.getElementById('editor-view');
        const loginButton = document.getElementById('login-button'), logoutButton = document.getElementById('logout-button');
        const addBlockButton = document.getElementById('add-block-button'), blockTypeSelect = document.getElementById('block-type-select');
        const dynamicBlocksContainer = document.getElementById('dynamic-content-blocks');
        const publishButton = document.getElementById('publish-button'), statusMessage = document.getElementById('status-message');
        const linkModal = document.getElementById('link-modal'), linkUrlInput = document.getElementById('link-url-input');
        const addLinkBtn = document.getElementById('add-link-btn'), cancelLinkBtn = document.getElementById('cancel-link-btn');
        const pasteModal = document.getElementById('paste-modal'), confirmPasteBtn = document.getElementById('confirm-paste-btn');
        const tagsInput = document.getElementById('article-tags');
        const categoriesInput = document.getElementById('article-categories');
        const countryContainer = document.getElementById('country-suggestions-container');
        const countrySearchInput = document.getElementById('country-search-input');
        const publishText = document.getElementById('publish-text');
        const publishSpinner = document.getElementById('publish-spinner');
        const saveIndicator = document.getElementById('save-indicator');

        // Global State
        let accessToken = null, activeTextarea = null, activeContentEditable = null, activeTableBlockId = null;
        let selectionStart = 0, selectionEnd = 0;
        let saveTimeout = null;

        // ==========================================
        // 2. HELPER FUNCTIONS
        // ==========================================
        
        const autoExpandTextarea = (textarea) => {
            if (!textarea) return;
            const currentScrollY = window.scrollY;
            const currentScrollX = window.scrollX;
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
            window.scrollTo(currentScrollX, currentScrollY);
        };

        function renderCountries(filterText = '') {
            countryContainer.innerHTML = ''; 
            const filtered = oicCountriesList.filter(country => 
                country.toLowerCase().includes(filterText.toLowerCase())
            );
            if (filtered.length === 0) {
                countryContainer.innerHTML = '<span class="text-xs text-slate-400 italic p-2">No country found</span>';
                return;
            }
            filtered.forEach(country => {
                const chip = document.createElement('div');
                chip.className = 'country-chip'; 
                chip.dataset.country = country; 
                chip.textContent = country;
                countryContainer.appendChild(chip);
            });
        }

        // --- HISTORY MANAGER (Table) ---
        const tableHistory = {}; 
        
        function initTableHistory(blockId) {
            tableHistory[blockId] = { undo: [], redo: [], timeout: null };
            setTimeout(() => saveTableState(blockId, true), 50);
        }

        function saveTableState(blockId, isInitialState = false) {
            if (!tableHistory[blockId]) return;
            const history = tableHistory[blockId];
            const block = document.getElementById(blockId);
            if (!block || block.classList.contains('restoring-state')) return;

            const theadHtml = block.querySelector('.sheet-head').innerHTML;
            const tbodyHtml = block.querySelector('.sheet-body').innerHTML;
            const stateSnapshot = { thead: theadHtml, tbody: tbodyHtml };

            if (isInitialState) {
                history.undo.push(stateSnapshot);
            } else {
                const lastState = history.undo[history.undo.length - 1];
                if (lastState && lastState.thead === theadHtml && lastState.tbody === tbodyHtml) return;
                history.undo.push(stateSnapshot);
                history.redo = []; 
            }
            updateHistoryButtons(blockId);
            triggerSave(); // LocalStorage
        }

        function undoTable(blockId) {
            const history = tableHistory[blockId];
            if (!history || history.undo.length <= 1) return;
            const block = document.getElementById(blockId);
            block.classList.add('restoring-state');
            history.redo.push(history.undo.pop());
            const previous = history.undo[history.undo.length - 1];
            applyTableState(blockId, previous);
            block.classList.remove('restoring-state');
            updateHistoryButtons(blockId);
            triggerSave();
        }

        function redoTable(blockId) {
            const history = tableHistory[blockId];
            if (!history || history.redo.length === 0) return;
            const block = document.getElementById(blockId);
            block.classList.add('restoring-state');
            const next = history.redo.pop();
            history.undo.push(next);
            applyTableState(blockId, next);
            block.classList.remove('restoring-state');
            updateHistoryButtons(blockId);
            triggerSave();
        }

        function applyTableState(blockId, state) {
            const block = document.getElementById(blockId);
            block.querySelector('.sheet-head').innerHTML = state.thead;
            block.querySelector('.sheet-body').innerHTML = state.tbody;
        }

        function updateHistoryButtons(blockId) {
            const history = tableHistory[blockId];
            if (!history) return;
            const undoBtn = document.getElementById(`btn-undo-${blockId}`);
            const redoBtn = document.getElementById(`btn-redo-${blockId}`);
            if (undoBtn) undoBtn.disabled = (history.undo.length <= 1);
            if (redoBtn) redoBtn.disabled = (history.redo.length === 0);
        }

        function debouncedTableSave(blockId) {
            if (tableHistory[blockId]) {
                clearTimeout(tableHistory[blockId].timeout);
                tableHistory[blockId].timeout = setTimeout(() => {
                    saveTableState(blockId);
                }, 1000);
            }
        }

        const updateStatus = (message, color) => {
            statusMessage.textContent = message;
            statusMessage.style.color = color;
            setTimeout(() => statusMessage.textContent = '', 6000);
        };

        const setPublishingState = (isPublishing) => {
            publishButton.disabled = isPublishing;
            publishText.classList.toggle('hidden', isPublishing);
            publishSpinner.classList.toggle('hidden', !isPublishing);
        };

        function showLinkModal(url = '') {
            linkUrlInput.value = url;
            linkModal.classList.add('visible');
            linkUrlInput.focus();
        }
        function hideLinkModal() {
            linkModal.classList.remove('visible');
            activeTextarea = null;
        }
        const showLogin = () => { loginView.classList.remove('hidden'); editorView.classList.add('hidden'); };
        const showEditor = () => { 
            loginView.classList.add('hidden'); 
            editorView.classList.remove('hidden'); 
            restoreDraft(); // RESTORE DATA ON LOAD
        };

        // ==========================================
        // 3. PERSISTENCE LAYER (AUTO SAVE/LOAD)
        // ==========================================
        function triggerSave() {
            saveIndicator.classList.remove('visible');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDraft, 1000);
        }

        function saveDraft() {
            const draft = {
                timestamp: Date.now(),
                repo: document.getElementById('target-repo-select').value,
                headline: document.getElementById('article-headline').value,
                subheadline: document.getElementById('article-subheadline').value,
                mainImageUrl: document.getElementById('article-main-image-url').value,
                author: document.getElementById('article-author').value,
                mainImageDesc: document.getElementById('article-main-image-desc').value,
                p1: document.getElementById('article-p1').value,
                tags: document.getElementById('article-tags').value,
                categories: document.getElementById('article-categories').value,
                blocks: []
            };

            document.querySelectorAll('.dynamic-content-block').forEach(block => {
                const type = block.dataset.blockType;
                const blockData = { type: type, id: block.id };
                
                if (type === 'table') {
                    // Check if table is created or in setup stage
                    const editorStage = block.querySelector('.editor-stage');
                    if (!editorStage.classList.contains('hidden')) {
                         blockData.caption = block.querySelector('.table-caption-input').value;
                         blockData.thead = block.querySelector('.sheet-head').innerHTML;
                         blockData.tbody = block.querySelector('.sheet-body').innerHTML;
                         blockData.theme = block.querySelector('.table-theme').value;
                         blockData.isTableReady = true;
                    } else {
                        blockData.isTableReady = false;
                    }
                } else if (['headline-h2','headline-h3','headline-h4'].includes(type)) {
                    blockData.value = block.querySelector('.dynamic-headline').value;
                } else if (type === 'paragraph') {
                    blockData.value = block.querySelector('.dynamic-paragraph').value;
                } else if (type === 'quote') {
                    blockData.value = block.querySelector('.dynamic-quote').value;
                } else if (type === 'image') {
                    blockData.url = block.querySelector('.dynamic-image-url').value;
                    blockData.desc = block.querySelector('.dynamic-image-desc').value;
                } else {
                    // Social
                    blockData.url = block.querySelector('.dynamic-social-url').value;
                    blockData.caption = block.querySelector('.dynamic-social-caption').value;
                }
                draft.blocks.push(blockData);
            });

            localStorage.setItem('tmp_cms_draft', JSON.stringify(draft));
            
            // Show saved indicator
            saveIndicator.classList.add('visible');
            setTimeout(() => saveIndicator.classList.remove('visible'), 2000);
        }

        function restoreDraft() {
            const saved = localStorage.getItem('tmp_cms_draft');
            if (!saved) return;

            try {
                const draft = JSON.parse(saved);
                document.getElementById('target-repo-select').value = draft.repo || 'tmp-articles-world-politics';
                document.getElementById('article-headline').value = draft.headline || '';
                document.getElementById('article-subheadline').value = draft.subheadline || '';
                document.getElementById('article-main-image-url').value = draft.mainImageUrl || '';
                document.getElementById('article-author').value = draft.author || 'TMP Staff';
                document.getElementById('article-main-image-desc').value = draft.mainImageDesc || '';
                document.getElementById('article-p1').value = draft.p1 || '';
                document.getElementById('article-tags').value = draft.tags || '';
                document.getElementById('article-categories').value = draft.categories || '';

                // Restore Blocks
                dynamicBlocksContainer.innerHTML = '';
                if (draft.blocks && draft.blocks.length > 0) {
                    draft.blocks.forEach(blockData => {
                        addBlockToDOM(blockData.type, blockData.id, blockData);
                    });
                }
                
                // Expand textareas
                document.querySelectorAll('textarea').forEach(autoExpandTextarea);

            } catch (e) {
                console.error("Failed to restore draft", e);
            }
        }

        function clearDraft() {
            localStorage.removeItem('tmp_cms_draft');
        }

        // ==========================================
        // 4. MAIN LOGIC (Auth & Init)
        // ==========================================
        window.onload = async () => {
            
            Sortable.create(dynamicBlocksContainer, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: function() { triggerSave(); } // Save on reorder
            });

            renderCountries();
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                window.history.pushState({}, document.title, window.location.pathname);
                try {
                    const response = await fetch(GITHUB_CONFIG.tokenExchangeUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: code })
                    });
                    const data = await response.json();
                    if (response.ok && data.access_token) {
                        accessToken = data.access_token;
                        localStorage.setItem('githubAccessToken', accessToken);
                        showEditor();
                    } else {
                        throw new Error(data.details || data.error || `Server responded with status ${response.status}.`);
                    }
                } catch (error) {
                    alert(`Authentication Failed:\n\n${error.message}`);
                    showLogin();
                }
            } else {
                const storedToken = localStorage.getItem('githubAccessToken');
                if (storedToken) {
                    accessToken = storedToken;
                    showEditor();
                } else {
                    showLogin();
                }
            }
        };

        // --- AUTH EVENTS ---
        loginButton.addEventListener('click', () => {
            const finalDestination = window.location.origin + window.location.pathname;
            localStorage.setItem('auth_redirect_info', JSON.stringify({ destination: finalDestination, cms_id: 'org_cms' })); 
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CONFIG.clientId}&scope=repo,user:email&org=${GITHUB_CONFIG.orgOwner}&state=org_cms`;
            window.location.href = authUrl;
        });

        logoutButton.addEventListener('click', async () => {
            if (accessToken) {
                try {
                    await fetch(GITHUB_CONFIG.tokenExchangeUrl, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: accessToken }),
                    });
                } catch (error) { console.error("Failed to revoke token, but logging out locally anyway:", error); }
            }
            accessToken = null;
            localStorage.removeItem('githubAccessToken');
            showLogin();
        });

        // --- GLOBAL EVENTS (Auto-Save Hooks) ---
        editorView.addEventListener('input', e => {
            // Auto expand textareas
            if (e.target.tagName.toLowerCase() === 'textarea') {
                autoExpandTextarea(e.target);
            }
            // Trigger Save on any input change
            triggerSave(); 
        });
        
        // Save on select changes too
        editorView.addEventListener('change', triggerSave);

        editorView.addEventListener('mouseup', (e) => {
            if (e.target.classList.contains('sheet-cell')) return;
            if (e.target.tagName.toLowerCase() === 'textarea') {
                const textarea = e.target;
                if (textarea.selectionStart !== textarea.selectionEnd) {
                    activeTextarea = textarea;
                    selectionStart = textarea.selectionStart;
                    selectionEnd = textarea.selectionEnd;
                    showLinkModal();
                }
            }
        });

        document.addEventListener('focusin', (e) => {
            if (e.target.classList.contains('sheet-cell')) {
                activeContentEditable = e.target;
                const block = e.target.closest('.dynamic-content-block');
                if (block && block.dataset.blockType === 'table') {
                    debouncedTableSave(block.id);
                }
            }
        });

        countrySearchInput.addEventListener('input', (e) => {
            renderCountries(e.target.value);
        });

        countryContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('country-chip')) {
                const countryNameRaw = e.target.dataset.country;
                const countrySlug = countryNameRaw.toLowerCase().replace(/\s+/g, '-');
                const currentCats = categoriesInput.value.split(',').map(c => c.trim()).filter(c => c);
                if (!currentCats.includes(countrySlug)) {
                    categoriesInput.value = categoriesInput.value.trim() === '' ? countrySlug : `${categoriesInput.value.trim()}, ${countrySlug}`;
                    const originalText = e.target.textContent;
                    e.target.textContent = "Added!";
                    e.target.style.backgroundColor = "#10b981"; e.target.style.color = "white";
                    setTimeout(() => { e.target.textContent = originalText; e.target.style.backgroundColor = ""; e.target.style.color = ""; }, 800);
                    triggerSave();
                }
            }
        });

        // Link Modal
        addLinkBtn.addEventListener('click', () => {
            if (activeTextarea) {
                const url = linkUrlInput.value.trim();
                if (url) {
                    const selectedText = activeTextarea.value.substring(selectionStart, selectionEnd);
                    const linkMarkdown = `[${selectedText}](${url})`;
                    activeTextarea.setRangeText(linkMarkdown, selectionStart, selectionEnd, 'select');
                    triggerSave();
                }
                hideLinkModal();
            } else if (activeContentEditable) {
                const url = linkUrlInput.value.trim();
                if(url) {
                    activeContentEditable.focus();
                    document.execCommand('createLink', false, url);
                    triggerSave();
                }
                hideLinkModal();
            }
        });
        cancelLinkBtn.addEventListener('click', hideLinkModal);
        
        // Tag Suggestions
        document.getElementById('tag-suggestions-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('tag-chip')) {
                const newTag = e.target.dataset.tag;
                const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
                if (!currentTags.includes(newTag)) {
                    tagsInput.value = tagsInput.value.trim() === '' ? newTag : `${tagsInput.value.trim()}, ${newTag}`;
                    triggerSave();
                }
            }
        });

        // Cat Suggestions
        document.getElementById('category-suggestions-container').addEventListener('click', (e) => {
            if (e.target.classList.contains('category-chip')) {
                const newCat = e.target.dataset.cat;
                const currentCats = categoriesInput.value.split(',').map(c => c.trim()).filter(c => c);
                if (!currentCats.includes(newCat)) {
                    categoriesInput.value = categoriesInput.value.trim() === '' ? newCat : `${categoriesInput.value.trim()}, ${newCat}`;
                    triggerSave();
                }
            }
        });


        // ==========================================
        // 5. TABLE LOGIC (FIXED)
        // ==========================================
        window.createTable = function(id) {
            const block = document.getElementById(id);
            const rows = parseInt(block.querySelector('.row-input').value)||2;
            const cols = parseInt(block.querySelector('.col-input').value)||2;
            block.querySelector('.setup-stage').classList.add('hidden');
            block.querySelector('.editor-stage').classList.remove('hidden');
            
            const thead = block.querySelector('.sheet-head');
            let headHtml = '<tr>';
            for(let c=0; c<cols; c++) {
                headHtml += `<td><div contenteditable="true" class="sheet-cell" data-placeholder="Header ${c+1}"></div></td>`;
            }
            headHtml += '</tr>';
            thead.innerHTML = headHtml;

            const tbody = block.querySelector('.sheet-body');
            let bodyHtml = '';
            for(let r=1; r<rows; r++) {
                bodyHtml += '<tr>';
                for(let c=0; c<cols; c++) {
                    bodyHtml += `<td><div contenteditable="true" class="sheet-cell" data-placeholder="Data"></div></td>`;
                }
                bodyHtml += '</tr>';
            }
            tbody.innerHTML = bodyHtml;

            initTableHistory(id);
            triggerSave();
        };

        window.tableCmd = function(cmd, id, arg=null) {
            const block = document.getElementById(id);
            if(!block) return;

            if(cmd === 'undo') { undoTable(id); return; }
            if(cmd === 'redo') { redoTable(id); return; }

            if(['addRow','addCol','delRow','delCol','mergeRight','mergeDown','bold','italic','underline','justifyLeft','justifyCenter','justifyRight','hiliteColor','formatBlock'].includes(cmd)) {
                saveTableState(id);
            }

            if(['bold','italic','underline','justifyLeft','justifyCenter','justifyRight','removeFormat','formatBlock'].includes(cmd)) {
                if(activeContentEditable && block.contains(activeContentEditable)) {
                    if(cmd.startsWith('justify')) {
                        activeContentEditable.parentElement.style.textAlign = cmd.replace('justify','').toLowerCase();
                    } else {
                        document.execCommand(cmd, false, arg);
                    }
                    activeContentEditable.focus();
                } else alert("Click a cell first.");
                triggerSave(); return;
            }

            if(cmd === 'hiliteColor') {
                if(activeContentEditable && block.contains(activeContentEditable)) {
                    activeContentEditable.parentElement.style.backgroundColor = arg;
                }
                triggerSave(); return;
            }

            if(cmd === 'mergeRight') {
                if(!activeContentEditable) return alert("Click cell to merge.");
                const td = activeContentEditable.parentElement;
                const nextTd = td.nextElementSibling;
                if(nextTd) {
                    const nextContent = nextTd.querySelector('.sheet-cell').innerHTML;
                    const currentColspan = parseInt(td.getAttribute('colspan')||1);
                    const nextColspan = parseInt(nextTd.getAttribute('colspan')||1);
                    td.setAttribute('colspan', currentColspan + nextColspan);
                    if(nextContent) activeContentEditable.innerHTML += ' ' + nextContent;
                    nextTd.remove();
                }
                triggerSave(); return;
            }
            if(cmd === 'mergeDown') {
                if(!activeContentEditable) return alert("Click cell to merge.");
                const td = activeContentEditable.parentElement;
                const tr = td.parentElement;
                const nextTr = tr.nextElementSibling;
                if(nextTr) {
                    const cellIndex = Array.from(tr.children).indexOf(td);
                    const targetTd = nextTr.children[cellIndex]; 
                    if(targetTd) {
                        const targetContent = targetTd.querySelector('.sheet-cell').innerHTML;
                        const currentRowspan = parseInt(td.getAttribute('rowspan')||1);
                        const targetRowspan = parseInt(targetTd.getAttribute('rowspan')||1);
                        td.setAttribute('rowspan', currentRowspan + targetRowspan);
                        if(targetContent) activeContentEditable.innerHTML += '<br>' + targetContent;
                        targetTd.remove();
                    }
                }
                triggerSave(); return;
            }

            if(cmd === 'openPaste') {
                activeTableBlockId = id;
                document.getElementById('paste-input').value = '';
                pasteModal.classList.add('visible');
            }

            if (cmd === 'addRow') {
                const tbody = block.querySelector('.sheet-body');
                const colInput = block.querySelector('.col-input');
                const colCount = colInput ? parseInt(colInput.value) : 2;
                
                let targetRow = null;
                if(activeContentEditable && block.contains(activeContentEditable)) {
                    const td = activeContentEditable.closest('td');
                    if(td) targetRow = td.parentElement;
                }

                const newRow = document.createElement('tr');
                for(let i=0; i<colCount; i++) {
                      const td = document.createElement('td');
                      td.innerHTML = `<div contenteditable="true" class="sheet-cell" data-placeholder="Data"></div>`;
                      newRow.appendChild(td);
                }

                if(targetRow) targetRow.after(newRow); 
                else tbody.appendChild(newRow);
                triggerSave();
            }
            else if (cmd === 'addCol') {
                const headRow = block.querySelector('.sheet-head tr'); 
                const tbody = block.querySelector('.sheet-body');
                
                const newTh = document.createElement('td');
                newTh.innerHTML = `<div contenteditable="true" class="sheet-cell" data-placeholder="Header"></div>`;
                headRow.appendChild(newTh);
                
                tbody.querySelectorAll('tr').forEach(tr => {
                    const td = document.createElement('td');
                    td.innerHTML = `<div contenteditable="true" class="sheet-cell" data-placeholder="Data"></div>`;
                    tr.appendChild(td);
                });

                const colInput = block.querySelector('.col-input');
                if(colInput) colInput.value = parseInt(colInput.value) + 1;
                triggerSave();
            }
            else if (cmd === 'delRow') {
                const tbody = block.querySelector('.sheet-body');
                if(activeContentEditable && block.contains(activeContentEditable)) {
                    const tr = activeContentEditable.closest('tr');
                    if(tr && tr.parentElement === tbody) { tr.remove(); triggerSave(); return; }
                }
                if(tbody.children.length > 0) tbody.removeChild(tbody.lastElementChild);
                triggerSave();
            }
            else if (cmd === 'delCol') {
                const allRows = block.querySelectorAll('tr'); 
                if(allRows[0].children.length > 1) {
                    allRows.forEach(row => row.removeChild(row.lastElementChild));
                    const colInput = block.querySelector('.col-input');
                    if(colInput) colInput.value = Math.max(1, parseInt(colInput.value) - 1);
                }
                triggerSave();
            }
        };

        // Handle Paste Import with Pipe Support
        confirmPasteBtn.onclick = () => {
            if(!activeTableBlockId) return;
            saveTableState(activeTableBlockId);
            const data = document.getElementById('paste-input').value.trim();
            if(!data) return;

            // Check if data is pipe separated
            const isPipe = data.includes('|');
            const rows = data.split('\n');
            
            // Build Head
            let headHtml = '<tr>';
            const headCells = rows[0].split(isPipe ? '|' : '\t');
            headCells.forEach(cell => {
                headHtml += `<td><div contenteditable="true" class="sheet-cell">${cell.trim()}</div></td>`;
            });
            headHtml += '</tr>';

            // Build Body
            let bodyHtml = '';
            for(let i = 1; i < rows.length; i++) {
                bodyHtml += '<tr>';
                const cells = rows[i].split(isPipe ? '|' : '\t'); 
                cells.forEach(cell => {
                    bodyHtml += `<td><div contenteditable="true" class="sheet-cell">${cell.trim()}</div></td>`;
                });
                bodyHtml += '</tr>';
            }

            const block = document.getElementById(activeTableBlockId);
            block.querySelector('.sheet-head').innerHTML = headHtml;
            block.querySelector('.sheet-body').innerHTML = bodyHtml;
            
            // Switch to editor view if not already
            block.querySelector('.setup-stage').classList.add('hidden');
            block.querySelector('.editor-stage').classList.remove('hidden');

            // Update col count input just in case
            block.querySelector('.col-input').value = headCells.length;
            initTableHistory(activeTableBlockId);
            
            pasteModal.classList.remove('visible');
            triggerSave();
        };

        // --- BLOCK MANAGEMENT ---
        
        // Refactored to allow generating HTML with data
        function createBlockHTML(blockType, blockId, data = {}) {
             let blockTitle = blockType.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            if (blockType.startsWith('headline')) {
                blockTitle = `Headline (${blockType.slice(-2).toUpperCase()})`;
            }
            
            let blockHTML = `
                <div class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></div>
                <button onclick="document.getElementById('${blockId}').remove(); triggerSave();" class="remove-block-btn" title="Remove block"><i class="fas fa-times"></i></button>
            `;
            
            if (blockType === 'table') {
                 const isReady = data.isTableReady;
                 const setupClass = isReady ? 'hidden' : '';
                 const editorClass = isReady ? '' : 'hidden';
                 
                 blockHTML += `
                    <h3 class="text-sm font-bold uppercase text-slate-400 mb-3">Data Table</h3>
                    <div class="setup-stage flex flex-wrap items-end gap-4 mb-4 ${setupClass}">
                        <div><label class="block text-xs text-slate-500 mb-1">Rows</label><input type="number" class="row-input border border-slate-300 p-2 rounded w-20 text-sm" value="3"></div>
                        <div><label class="block text-xs text-slate-500 mb-1">Cols</label><input type="number" class="col-input border border-slate-300 p-2 rounded w-20 text-sm" value="3"></div>
                        <button onclick="createTable('${blockId}')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm h-10 font-medium">Create</button>
                        <button onclick="tableCmd('openPaste','${blockId}')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 text-sm h-10 font-medium ml-2"><i class="fas fa-file-import"></i> Paste Excel/Pipe</button>
                    </div>
                    
                    <div class="editor-stage ${editorClass}">
                        <div class="table-settings-container">
                            <input type="text" class="table-caption-input" placeholder="Table Caption (e.g. Source: World Bank, 2024)" value="${data.caption || ''}">
                            <div class="table-footer-options">
                                <select class="table-theme border border-slate-300 p-1 rounded text-xs">
                                    <option value="" ${!data.theme ? 'selected':''}>Default Theme</option>
                                    <option value="striped" ${data.theme==='striped'?'selected':''}>Striped</option>
                                    <option value="grid" ${data.theme==='grid'?'selected':''}>Grid Border</option>
                                </select>
                                <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-500"><input type="checkbox" class="table-sortable"> Sortable</label>
                            </div>
                        </div>

                        <div class="table-toolbar-container">
                            <div class="table-toolbar-row">
                                <div class="table-tool-group border-r-2 border-indigo-100 pr-4">
                                    <button id="btn-undo-${blockId}" class="tool-btn" onclick="tableCmd('undo', '${blockId}')" title="Undo"><i class="fas fa-undo"></i></button>
                                    <button id="btn-redo-${blockId}" class="tool-btn" onclick="tableCmd('redo', '${blockId}')" title="Redo"><i class="fas fa-redo"></i></button>
                                </div>
                                <span class="section-label">Style</span>
                                <div class="table-tool-group">
                                    <button class="tool-btn" onclick="tableCmd('bold', '${blockId}')" title="Bold"><i class="fas fa-bold"></i></button>
                                    <button class="tool-btn" onclick="tableCmd('italic', '${blockId}')" title="Italic"><i class="fas fa-italic"></i></button>
                                    <button class="tool-btn" onclick="tableCmd('underline', '${blockId}')" title="Underline"><i class="fas fa-underline"></i></button>
                                </div>
                                <div class="table-tool-group">
                                    <button class="tool-btn" onclick="tableCmd('justifyLeft', '${blockId}')"><i class="fas fa-align-left"></i></button>
                                    <button class="tool-btn" onclick="tableCmd('justifyCenter', '${blockId}')"><i class="fas fa-align-center"></i></button>
                                    <button class="tool-btn" onclick="tableCmd('justifyRight', '${blockId}')"><i class="fas fa-align-right"></i></button>
                                </div>
                                <div class="table-tool-group">
                                    <div class="color-picker-wrapper tool-btn">
                                        <i class="fas fa-fill-drip mr-1"></i>
                                        <input type="color" onchange="tableCmd('hiliteColor','${blockId}',this.value)" title="Cell Background">
                                    </div>
                                </div>
                                <div class="table-tool-group">
                                    <button class="tool-btn" onclick="tableCmd('formatBlock', '${blockId}', '<h1>')">H1</button>
                                    <button class="tool-btn" onclick="tableCmd('formatBlock', '${blockId}', '<h2>')">H2</button>
                                </div>
                            </div>

                            <div class="table-toolbar-row">
                                <span class="section-label">Structure</span>
                                <div class="table-tool-group">
                                    <button class="tool-btn text-indigo-600" onclick="tableCmd('addRow', '${blockId}')" title="Insert Row Below"><i class="fas fa-plus"></i> Row</button>
                                    <button class="tool-btn text-indigo-600" onclick="tableCmd('addCol', '${blockId}')" title="Insert Column Right"><i class="fas fa-plus"></i> Col</button>
                                </div>
                                <div class="table-tool-group">
                                    <button class="tool-btn" onclick="tableCmd('mergeRight', '${blockId}')" title="Merge Right"><i class="fas fa-arrows-alt-h"></i></button>
                                    <button class="tool-btn" onclick="tableCmd('mergeDown', '${blockId}')" title="Merge Down"><i class="fas fa-arrows-alt-v"></i></button>
                                </div>
                                <div class="table-tool-group">
                                    <button class="tool-btn text-red-500 hover:text-red-700" onclick="tableCmd('delRow', '${blockId}')" title="Delete Row"><i class="fas fa-trash-alt"></i> Row</button>
                                    <button class="tool-btn text-red-500 hover:text-red-700" onclick="tableCmd('delCol', '${blockId}')" title="Delete Column"><i class="fas fa-trash-alt"></i> Col</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-wrapper">
                            <table class="sheet-table">
                                <thead class="sheet-head">${data.thead || ''}</thead>
                                <tbody class="sheet-body">${data.tbody || ''}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                blockHTML += `<h3 class="text-sm font-bold uppercase text-slate-400 mb-3">${blockTitle}</h3>`;
                switch (blockType) {
                    case 'paragraph': blockHTML += `<textarea class="dynamic-paragraph w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="6" placeholder="Continue your article...">${data.value || ''}</textarea>`; break;
                    case 'headline-h2': case 'headline-h3': case 'headline-h4': blockHTML += `<input type="text" class="dynamic-headline w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-bold" placeholder="Enter headline text..." value="${data.value || ''}">`; break;
                    case 'image': blockHTML += `<div class="mb-4"><label class="block text-sm font-medium text-slate-700 mb-1">Image URL</label><input type="text" class="dynamic-image-url w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://example.com/image.jpg" value="${data.url || ''}"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Image Description</label><textarea rows="1" class="dynamic-image-desc w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="A short description of this image">${data.desc || ''}</textarea></div>`; break;
                    case 'quote': blockHTML += `<textarea class="dynamic-quote w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Enter the quote here...">${data.value || ''}</textarea>`; break;
                    default: blockHTML += `<div class="mb-4"><label class="block text-sm font-medium text-slate-700 mb-1">${blockTitle} Post URL</label><input type="text" class="dynamic-social-url w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste the full post URL" value="${data.url || ''}"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Caption (optional)</label><textarea rows="1" class="dynamic-social-caption w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="A short caption for the embed">${data.caption || ''}</textarea></div>`; break;
                }
            }
            return blockHTML;
        }

        function addBlockToDOM(blockType, blockId, data={}) {
            const newBlock = document.createElement('div');
            newBlock.className = 'dynamic-content-block';
            newBlock.dataset.blockType = blockType;
            newBlock.id = blockId;
            newBlock.innerHTML = createBlockHTML(blockType, blockId, data);
            dynamicBlocksContainer.appendChild(newBlock);
            if(data.isTableReady) initTableHistory(blockId); // Init history for restored tables
        }

        addBlockButton.addEventListener('click', () => {
            const blockType = blockTypeSelect.value;
            const blockId = `dynamic-block-${Date.now()}`;
            addBlockToDOM(blockType, blockId);
            const newBlock = document.getElementById(blockId);
            newBlock.querySelectorAll('textarea').forEach(autoExpandTextarea);
            triggerSave();
        });

        // --- NEW: NOTIFICATION TRIGGER ---
        async function triggerNotificationSystem(headline, subheadline, author, mainImageUrl) {
            console.log("ð Triggering Notification System...");
            
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.notifyOwner}/${GITHUB_CONFIG.notifyRepo}/dispatches`;
            
            // Notification Payload
            const payload = {
                event_type: "new_notification",
                client_payload: {
                    headline: headline,
                    subheadline: subheadline || "New article published on TMP News",
                    author: author,
                    image_url: mainImageUrl,
                    date: new Date().toISOString(),
                    type: "standard"
                }
            };

            try {
                // We use the SAME accessToken that we used for publishing
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Authorization": `token ${accessToken}`,
                        "Accept": "application/vnd.github.v3+json",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    console.log("â Notification Signal Sent!");
                } else {
                    const errText = await response.text();
                    console.error("â Notification Signal Failed:", errText);
                    // Warn user if it fails (likely due to permissions)
                    updateStatus(`Article Saved! (Notification Signal Failed: ${errText})`, '#f59e0b');
                }
            } catch (error) {
                console.error("â Notification Network Error:", error);
            }
        }

        publishButton.addEventListener('click', async () => {
            const headline = document.getElementById('article-headline').value.trim();
            const paragraph1 = document.getElementById('article-p1').value.trim();
            const selectedRepo = document.getElementById('target-repo-select').value;
            
            if (!headline || !paragraph1) {
                updateStatus('Headline and Paragraph 1 are required.', '#ef4444');
                return;
            }

            setPublishingState(true);
            
            const subheadline = document.getElementById('article-subheadline').value.trim();
            const mainImageUrl = document.getElementById('article-main-image-url').value.trim();
            const mainImageDesc = document.getElementById('article-main-image-desc').value.trim();
            const authorName = document.getElementById('article-author').value.trim();
            const tags = tagsInput.value.trim();
            const categories = categoriesInput.value.trim(); 

            let frontmatter = `---\n`;
            frontmatter += `title: "${headline.replace(/"/g, '\\"')}"\n`;
            if (subheadline) frontmatter += `subheadline: "${subheadline.replace(/"/g, '\\"')}"\n`;
            frontmatter += `date: ${new Date().toISOString()}\n`;
            if (mainImageUrl) frontmatter += `image: "${mainImageUrl}"\n`;
            if (mainImageDesc) frontmatter += `image_description: "${mainImageDesc.replace(/"/g, '\\"')}"\n`;
            const tagList = tags.split(',').map(tag => tag.trim().toLowerCase().replace(/\s+/g, '-')).filter(t => t);
            if (tagList.length > 0) frontmatter += `tags: [${tagList.join(', ')}]\n`;
            const catList = categories.split(',').map(c => c.trim().toLowerCase().replace(/\s+/g, '-')).filter(c => c);
            if (catList.length > 0) {
                frontmatter += `categories: [${catList.join(', ')}]\n`;
            }
            frontmatter += `author: "${authorName.replace(/"/g, '\\"')}"\n`;
            frontmatter += `layout: post\n`;
            frontmatter += `---\n\n`;

            let body = `${paragraph1}\n\n`;
            document.querySelectorAll('.dynamic-content-block').forEach(block => {
                const blockType = block.dataset.blockType;
                
                if (blockType === 'table') {
                    const caption = block.querySelector('.table-caption-input').value;
                    const theme = block.querySelector('.table-theme').value;
                    const sortable = block.querySelector('.table-sortable').checked ? 'sortable' : '';
                    
                    let tableHtml = `<div class="table-container ${theme}"><table class="${sortable}">\n`;
                    if(caption) tableHtml += `<caption>${caption}</caption>\n`;
                    
                    tableHtml += '  <thead>\n   <tr>\n';
                    block.querySelectorAll('.sheet-head .sheet-cell').forEach(cell => {
                           tableHtml += `       <th>${cell.innerHTML.trim()}</th>\n`;
                    });
                    tableHtml += '    </tr>\n  </thead>\n  <tbody>\n';
                    
                    block.querySelectorAll('.sheet-body tr').forEach(row => {
                        tableHtml += '    <tr>\n';
                        row.querySelectorAll('td').forEach(td => {
                            const style = td.getAttribute('style') || '';
                            const colspan = td.getAttribute('colspan');
                            const rowspan = td.getAttribute('rowspan');
                            let attrs = style ? ` style="${style}"` : '';
                            if(colspan) attrs += ` colspan="${colspan}"`;
                            if(rowspan) attrs += ` rowspan="${rowspan}"`;
                            
                            const cell = td.querySelector('.sheet-cell');
                            tableHtml += `      <td${attrs}>${cell.innerHTML.trim()}</td>\n`;
                        });
                        tableHtml += '    </tr>\n';
                    });
                    tableHtml += '  </tbody>\n</table></div>\n\n';
                    body += tableHtml;
                }
                else {
                    switch (blockType) {
                        case 'paragraph': body += `${block.querySelector('.dynamic-paragraph').value.trim()}\n\n`; break;
                        case 'headline-h2': body += `## ${block.querySelector('.dynamic-headline').value.trim()}\n\n`; break;
                        case 'headline-h3': body += `### ${block.querySelector('.dynamic-headline').value.trim()}\n\n`; break;
                        case 'headline-h4': body += `#### ${block.querySelector('.dynamic-headline').value.trim()}\n\n`; break;
                        case 'image':
                            const imageUrl = block.querySelector('.dynamic-image-url').value.trim();
                            const imageDesc = block.querySelector('.dynamic-image-desc').value.trim();
                            if (imageUrl) body += `![${imageDesc || 'Article image'}](${imageUrl})\n\n`;
                            break;
                        case 'quote':
                            const quote = block.querySelector('.dynamic-quote').value.trim();
                            if (quote) body += `> ${quote.replace(/\n/g, '\n> ')}\n\n`;
                            break;
                        default:
                            const url = block.querySelector('.dynamic-social-url').value.trim();
                            const caption = block.querySelector('.dynamic-social-caption').value.trim();
                            
                            if (url) {
                                let embedHtml = '';
                                if (blockType.startsWith('twitter')) {
                                    const cleanUrl = url.replace('x.com', 'twitter.com');
                                    embedHtml = `<blockquote class="twitter-tweet" data-dnt="true" data-theme="light"><a href="${cleanUrl}"></a></blockquote>`;
                                } 
                                else if (blockType.startsWith('instagram')) {
                                    embedHtml = `<blockquote class="instagram-media" data-instgrm-permalink="${url}" data-instgrm-version="14"></blockquote>`;
                                }
                                else if (blockType === 'tiktok') {
                                    const videoId = url.split('/').pop();
                                    embedHtml = `<blockquote class="tiktok-embed" cite="${url}" data-video-id="${videoId}" style="max-width: 605px;min-width: 325px;"> <section> <a target="_blank" href="${url}"></a> </section> </blockquote>`;
                                }
                                else if (blockType === 'youtube') {
                                    let videoId = '';
                                    if(url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
                                    else if(url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1];
                                    
                                    if(videoId) {
                                        embedHtml = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width:100%; aspect-ratio:16/9;"></iframe>`;
                                    } else {
                                        embedHtml = `<a href="${url}">${url}</a>`;
                                    }
                                }
                                else {
                                    embedHtml = `<a href="${url}" target="_blank" rel="noopener">View Post on ${blockType}</a>`;
                                }

                                body += `<div class="embed-container">\n${embedHtml}\n<div class="embed-caption">${caption}</div>\n</div>\n\n`;
                            }
                            break;
                    }
                }
            });

            const fileContent = frontmatter + body;
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const slug = headline.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            
            let filePath, owner;

            if (selectedRepo === 'TMP_Host') {
                filePath = `_posts/${dateStr}-${slug}.md`;
                owner = GITHUB_CONFIG.legacyOwner; 
            } else {
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                filePath = `posts/${year}/${month}/${dateStr}-${slug}.md`;
                owner = GITHUB_CONFIG.orgOwner; 
            }

            const commitMessage = `feat: Add new article "${headline}"`;
            const url = `https://api.github.com/repos/${owner}/${selectedRepo}/contents/${filePath}`;
            
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${accessToken}`, 'Accept': 'application/vnd.github.v3+json' },
                    body: JSON.stringify({ message: commitMessage, content: btoa(unescape(encodeURIComponent(fileContent))), branch: GITHUB_CONFIG.repoBranch }),
                });
                if (response.status === 201) {
                    updateStatus(`Article saved to ${selectedRepo}! Triggering build...`, '#16a34a');

                    // 1. Trigger Build (Legacy Site)
                    try {
                        await fetch(`https://api.github.com/repos/zaidalamgir/TMP_Host/dispatches`, {
                            method: 'POST',
                            headers: { 
                                'Authorization': `token ${accessToken}`, 
                                'Accept': 'application/vnd.github.v3+json' 
                            },
                            body: JSON.stringify({ event_type: 'new-article-post' })
                        });
                        console.log("Build signal sent to TMP_Host");
                    } catch (err) {
                        console.error("Failed to trigger build:", err);
                    }

                    // 2. Trigger Notification System (New Repo)
                    await triggerNotificationSystem(headline, subheadline, authorName, mainImageUrl);

                    updateStatus(`Published & Build Triggered!`, '#16a34a');
                    
                    // CLEAR SAVED DRAFT
                    clearDraft();
                    
                    editorView.querySelectorAll('input:not(.sheet-cell), textarea').forEach(el => { if(el.id !== 'article-author') el.value = ''; });
                    dynamicBlocksContainer.innerHTML = '';
                    document.querySelectorAll('textarea').forEach(autoExpandTextarea);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || `GitHub API returned status ${response.status}`);
                }
            } catch (error) {
                updateStatus(`Error: ${error.message}`, '#ef4444');
            } finally {
                setPublishingState(false);
            }
        });
    </script>
</body>
</html>
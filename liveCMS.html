<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live CMS - Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden { display: none !important; }
        
        /* --- GLASS UI & PANELS --- */
        .glass-panel { background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        /* --- STATIC INPUTS (Fixed - Non Draggable/Removable) --- */
        .static-field-group { margin-bottom: 1.5rem; position: relative; }
        .static-label { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 0.5rem; }
        .static-textarea, .static-input { 
            transition: all 0.2s; 
            background-color: #f8fafc; 
            overflow: hidden; 
            resize: none; 
        }
        .static-textarea:focus, .static-input:focus { background-color: #fff; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); border-color: #6366f1; }
        
        /* --- DYNAMIC BLOCK STYLES --- */
        .dynamic-content-block {
            border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; 
            padding: 3.5rem 1.25rem 1.5rem 1.25rem; 
            margin-top: 1.5rem; 
            background-color: #ffffff; 
            position: relative;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            transition: all 0.2s ease;
        }
        .dynamic-content-block:hover { border-color: #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }

        /* Drag Handle */
        .drag-handle {
            position: absolute; top: 0; left: 0; width: 100%; height: 2.5rem; 
            display: flex; align-items: center; justify-content: center; 
            cursor: grab; color: #94a3b8; background-color: #f8fafc; 
            border-bottom: 1px solid #e2e8f0; border-radius: 0.75rem 0.75rem 0 0; 
            z-index: 10;
        }
        .drag-handle:hover { background-color: #f1f5f9; color: #64748b; cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #f8fafc; border: 2px dashed #cbd5e1; }

        /* Delete Button */
        .remove-block-btn { 
            position: absolute; top: 1.25rem; transform: translateY(-50%); right: 0.75rem; 
            width: 1.75rem; height: 1.75rem; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            padding: 0; margin: 0; line-height: 1; 
            color: #ef4444; cursor: pointer; transition: all 0.2s; z-index: 20; 
        }
        .remove-block-btn:hover { background-color: #fee2e2; }

        /* --- CHIPS & TAGS --- */
        .tag-suggestions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
        .tag-chip, .category-chip, .country-chip {
            font-size: 0.75rem; font-weight: 600; padding: 0.35rem 0.85rem;
            border-radius: 9999px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .tag-chip { background-color: #f1f5f9; color: #475569; }
        .tag-chip:hover { background-color: #e2e8f0; transform: translateY(-1px); }
        .country-chip { background-color: #ecfdf5; color: #047857; border-color: #6ee7b7; }
        .country-chip:hover { background-color: #d1fae5; transform: translateY(-1px); }
        .country-list-scroll { max-height: 220px; overflow-y: auto; padding: 4px; border: 1px solid #f1f5f9; background: #f8fafc; border-radius: 0.5rem; }

        /* --- TABLE STYLES --- */
        .table-wrapper { overflow-x: auto; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-top: 10px; max-width: 100%; }
        .sheet-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .sheet-table th, .sheet-table td { border: 1px solid #e2e8f0; padding: 0; vertical-align: top; position: relative; }
        .sheet-table thead td { background-color: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .sheet-cell { width: 100%; outline: none; padding: 12px; min-height: 44px; font-size: 0.9rem; color: #334155; cursor: text; }
        .sheet-cell:focus { background-color: rgba(99, 102, 241, 0.05); box-shadow: inset 0 0 0 2px #6366f1; }
        .sheet-cell:empty:before { content: attr(data-placeholder); color: #94a3b8; }
        
        /* Table Toolbar */
        .table-toolbar-container { background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0; margin-bottom: 10px; padding: 4px; }
        .table-toolbar-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; padding: 4px; }
        .table-tool-group { display: flex; gap: 2px; border-right: 1px solid #cbd5e1; padding-right: 6px; margin-right: 2px; }
        .tool-btn { padding: 6px 8px; border-radius: 4px; cursor: pointer; color: #475569; font-size: 0.8rem; background: white; border: 1px solid #cbd5e1; display: flex; align-items: center; gap: 4px; }
        .tool-btn:hover:not(:disabled) { background: #e2e8f0; color: #1e293b; }
        
        .table-settings-container { margin-top: 10px; padding: 12px; background: #f1f5f9; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
        .table-caption-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem; background: white; display: block; }
        .table-footer-options { display: flex; gap: 15px; align-items: center; font-size: 0.85rem; color: #64748b; }
        
        /* --- GENERAL --- */
        textarea, input, select { transition: border-color 0.2s, box-shadow 0.2s; outline: none; }
        textarea:focus, input:focus, select:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .password-wrapper { position: relative; }
        .toggle-password { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: #9ca3af; }
        
        #edit-modal.open { display: flex !important; }
        #edit-modal-content { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <div id="app" class="w-full">
        
        <div id="auth-view" class="flex items-center justify-center min-h-screen p-4">
             <div class="glass-panel p-8 rounded-2xl shadow-xl w-full max-w-md mx-auto">
                 <form id="sign-in-form">
                     <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600"><i class="fas fa-bolt text-xl"></i></div>
                     <h1 class="text-2xl font-extrabold mb-6 text-center text-slate-900">Live CMS Login</h1>
                     <div class="mb-4">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Email</label>
                        <input type="email" id="sign-in-email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                     </div>
                     <div class="mb-6">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Password</label>
                         <div class="password-wrapper">
                             <input type="password" id="sign-in-password" class="w-full p-3 border border-slate-300 rounded-lg" required data-target="sign-in-password">
                             <i class="fas fa-eye-slash toggle-password" data-target="sign-in-password"></i>
                         </div>
                     </div>
                     <button type="submit" class="bg-slate-900 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-800 w-full transition-all">Sign In</button>
                     <p class="text-sm text-center text-slate-600 mt-4">Writer Access Only. <a href="#" id="show-sign-up" class="font-semibold text-indigo-600 hover:underline">New?</a></p>
                 </form>

                 <form id="sign-up-form" class="hidden">
                     <h1 class="text-2xl font-bold mb-6 text-center">Create Account</h1>
                     <div class="mb-4">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Email</label>
                        <input type="email" id="sign-up-email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                     </div>
                     <div class="mb-6">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Password</label>
                         <div class="password-wrapper">
                             <input type="password" id="sign-up-password" class="w-full p-3 border border-slate-300 rounded-lg" required data-target="sign-up-password">
                             <i class="fas fa-eye-slash toggle-password" data-target="sign-up-password"></i>
                         </div>
                     </div>
                     <button type="submit" class="bg-slate-900 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-800 w-full">Sign Up</button>
                     <p class="text-sm text-center text-slate-600 mt-4"><a href="#" id="show-sign-in" class="font-semibold text-indigo-600 hover:underline">Back to Login</a></p>
                 </form>
                 <p id="auth-message" class="text-center mt-4 text-sm font-medium"></p>
             </div>
        </div>

        <div id="editor-view" class="hidden">
             <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-slate-200 p-4 sticky top-0 z-30">
                 <div class="max-w-7xl mx-auto flex justify-between items-center">
                     <div class="flex items-center gap-2">
                        <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded animate-pulse">LIVE</span>
                        <h1 class="text-lg font-bold text-slate-800">Content Management</h1>
                     </div>
                     <div class="flex items-center gap-4">
                        <span id="writer-email" class="text-xs font-medium text-slate-500 hidden md:block"></span>
                        <button id="logout-button" class="text-sm font-medium text-slate-600 hover:text-red-500 bg-slate-100 px-3 py-1 rounded-md transition-colors">Logout</button>
                    </div>
                </div>
             </header>

             <main class="w-full max-w-7xl mx-auto p-4 md:p-6 lg:grid lg:grid-cols-12 lg:gap-8">
                 <div class="lg:col-span-8 mb-8 lg:mb-0">
                     <div class="glass-panel p-6 sm:p-8 rounded-2xl">
                         <h2 class="text-2xl font-extrabold mb-6 text-slate-900">New Update</h2>
                         
                         <div class="static-field-group">
                             <label class="static-label">Headline</label>
                             <textarea id="static-headline" rows="1" class="static-textarea w-full p-3 border border-slate-300 rounded-lg font-bold text-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter main headline..."></textarea>
                         </div>
                         
                         <div class="static-field-group">
                             <label class="static-label">Main Content</label>
                             <textarea id="static-content" rows="6" class="static-textarea w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-h-[150px]" placeholder="Start writing your main update here..."></textarea>
                         </div>

                         <div class="static-field-group">
                            <label class="static-label"><i class="fas fa-image mr-1"></i> Featured Image Link</label>
                            <input type="text" id="static-image" class="static-input w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="https://example.com/image.jpg">
                            <input type="text" id="static-image-caption" class="static-input w-full p-3 border border-slate-300 rounded-lg text-sm mt-2" placeholder="Image Caption / Description">
                         </div>

                         <div class="static-field-group">
                            <label class="static-label"><i class="fab fa-twitter mr-1"></i> Twitter Video Link</label>
                            <input type="text" id="static-twitter" class="static-input w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="https://x.com/user/status/123456...">
                            <input type="text" id="static-twitter-caption" class="static-input w-full p-3 border border-slate-300 rounded-lg text-sm mt-2" placeholder="Video Caption">
                         </div>

                         <div class="static-field-group">
                            <label class="static-label"><i class="fab fa-youtube mr-1"></i> YouTube Video Link</label>
                            <input type="text" id="static-youtube" class="static-input w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="https://youtube.com/watch?v=...">
                            <input type="text" id="static-youtube-caption" class="static-input w-full p-3 border border-slate-300 rounded-lg text-sm mt-2" placeholder="Video Caption">
                         </div>

                         <div id="content-blocks-container"></div>
                         
                         <div class="mt-8 p-4 bg-slate-50 rounded-xl border border-dashed border-slate-300 flex flex-col sm:flex-row items-center justify-center gap-3">
                             <select id="block-type-select" class="p-2.5 border border-slate-300 rounded-lg bg-white shadow-sm min-w-[200px] text-sm">
                                 <option value="content">Paragraph (Extra)</option>
                                 <option value="table">Table (Pro)</option>
                                 <option value="image">Image (Extra)</option>
                                 <option value="quote">Quote</option>
                                 <option value="link-button">Link / Button</option>
                                 <optgroup label="Social Media Embeds">
                                     <option value="twitter">Twitter (X)</option>
                                     <option value="twitter-video">Twitter (Video)</option>
                                     <option value="instagram">Instagram</option>
                                     <option value="instagram-video">Instagram (Video)</option>
                                     <option value="facebook">Facebook</option>
                                     <option value="tiktok">TikTok</option>
                                     <option value="youtube">YouTube</option>
                                     <option value="telegram">Telegram</option>
                                     <option value="reddit">Reddit</option>
                                     <option value="linkedin">LinkedIn</option>
                                 </optgroup>
                                 <optgroup label="Live Widgets">
                                     <option value="live-score-embed">Live Score Embed</option>
                                     <option value="weather-embed">Weather Map</option>
                                     <option value="html-code">Custom HTML</option>
                                 </optgroup>
                             </select>
                             <button id="add-block-button" class="bg-slate-800 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-slate-700 shadow-sm flex items-center gap-2">
                                <i class="fas fa-plus"></i> Add Block
                             </button>
                         </div>

                         <div class="mt-8 pt-6 border-t border-slate-100">
                             <label class="block text-sm font-bold text-slate-700 mb-2">Tags & Topics</label>
                             <input type="text" id="tags-input" class="w-full p-3 border border-slate-300 rounded-lg text-sm" value="BREAKING, TMP NEWS" placeholder="comma, separated, tags">
                             
                             <div class="tag-suggestions mt-2">
                                 <div class="tag-chip" data-tag="breaking">Breaking</div>
                                 <div class="tag-chip" data-tag="update">Update</div>
                                 <div class="tag-chip" data-tag="analysis">Analysis</div>
                             </div>

                             <div class="mt-4">
                                <label class="block text-xs font-bold text-emerald-600 uppercase mb-1">Add Country Tag</label>
                                <input type="text" id="country-search-input" class="w-full p-2 text-xs border border-emerald-200 rounded-lg mb-2" placeholder="Search OIC Country...">
                                <div id="country-suggestions-container" class="tag-suggestions country-list-scroll"></div>
                             </div>
                         </div>

                         <button id="publish-button" class="mt-8 bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-500 shadow-lg hover:shadow-indigo-500/30 w-full flex items-center justify-center text-lg transition-all">
                             <span id="publish-text">Publish Update</span>
                             <span id="publish-spinner" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i> Publishing...</span>
                         </button>
                         <p id="status-message" class="text-center mt-4 text-sm font-medium"></p>
                     </div>
                 </div>
                 
                 <div class="lg:col-span-4">
                     <div class="glass-panel p-6 rounded-2xl sticky top-24">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-slate-800">Recent Feed</h2>
                            <button onclick="fetchRecentPosts()" class="text-xs text-indigo-600 hover:underline"><i class="fas fa-sync"></i> Refresh</button>
                        </div>
                        <div id="recent-posts-feed" class="space-y-3 max-h-[70vh] overflow-y-auto pr-1 scrollbar-thin"></div>
                    </div>
                 </div>
             </main>
        </div>

        <div id="edit-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 items-center justify-center p-4">
             <div id="edit-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                 <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="text-xl font-bold">Edit Post</h2>
                    <button id="cancel-edit-btn-x" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                 </div>
                 <div class="p-6 overflow-y-auto">
                     <div class="mb-4">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Headline</label>
                        <input type="text" id="edit-headline" class="w-full p-3 border border-slate-300 rounded-lg">
                    </div>
                     <div class="mb-4">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Content (Markdown/HTML)</label>
                        <textarea id="edit-content" class="w-full p-3 border border-slate-300 rounded-lg min-h-[200px] font-mono text-sm leading-relaxed"></textarea>
                    </div>
                     <div class="mb-4">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Tags</label>
                        <input type="text" id="edit-tags" class="w-full p-3 border border-slate-300 rounded-lg">
                    </div>
                 </div>
                 <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                    <button id="cancel-edit-btn" class="px-5 py-2.5 rounded-lg text-slate-600 font-bold hover:bg-slate-200 transition-colors">Cancel</button>
                    <button id="save-edit-btn" class="px-5 py-2.5 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-500 shadow-md transition-colors">Save Changes</button>
                </div>
             </div>
        </div>
        
        <div id="paste-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                 <h3 class="text-lg font-bold mb-2">Paste from Excel</h3>
                 <p class="text-xs text-slate-500 mb-4">Copy cells from your spreadsheet and paste below.</p>
                 <textarea id="paste-input" class="w-full h-32 border p-2 rounded mb-4 text-xs font-mono"></textarea>
                 <div class="flex justify-end gap-2">
                     <button onclick="document.getElementById('paste-modal').classList.add('hidden')" class="px-4 py-2 bg-slate-100 rounded text-sm font-bold">Cancel</button>
                     <button id="confirm-paste-btn" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-bold">Import</button>
                 </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const SUPABASE_URL = 'https://ofszjurrajwtbwlfckhi.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mc3pqdXJyYWp3dGJ3bGZja2hpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDk2MzgsImV4cCI6MjA3NDk4NTYzOH0.kKafp8dEL7V0Y10-oNbjluYblA03a0V_OqB9XOBd9SA';
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const oicCountriesList = [
                "Afghanistan", "Albania", "Algeria", "Azerbaijan", "Bahrain", "Bangladesh", "Benin", "Brunei", "Burkina Faso", "Cameroon", "Chad", "Comoros", "CÃ´te d'Ivoire", "Djibouti", "Egypt", "Gabon", "Gambia", "Guinea", "Guinea-Bissau", "Guyana", "Indonesia", "Iran", "Iraq", "Jordan", "Kazakhstan", "Kuwait", "Kyrgyzstan", "Lebanon", "Libya", "Malaysia", "Maldives", "Mali", "Mauritania", "Morocco", "Mozambique", "Niger", "Nigeria", "Oman", "Pakistan", "Palestine", "Qatar", "Saudi Arabia", "Senegal", "Sierra Leone", "Somalia", "Sudan", "Suriname", "Syria", "Tajikistan", "Togo", "Tunisia", "Turkey", "Turkmenistan", "Uganda", "United Arab Emirates", "Uzbekistan", "Yemen", "Kosovo"
            ];

            const authView = document.getElementById('auth-view'), editorView = document.getElementById('editor-view');
            const signInForm = document.getElementById('sign-in-form'), signUpForm = document.getElementById('sign-up-form');
            const logoutButton = document.getElementById('logout-button'), authMessage = document.getElementById('auth-message');
            const blocksContainer = document.getElementById('content-blocks-container');
            const publishButton = document.getElementById('publish-button'), statusMessage = document.getElementById('status-message');
            const addBlockBtn = document.getElementById('add-block-button'), blockTypeSelect = document.getElementById('block-type-select');
            const tagsInput = document.getElementById('tags-input');
            
            // STATIC FIELD REFERENCES
            const staticHeadline = document.getElementById('static-headline');
            const staticContent = document.getElementById('static-content');
            
            // NEW STATIC FIELDS & CAPTIONS
            const staticImage = document.getElementById('static-image');
            const staticImageCaption = document.getElementById('static-image-caption');
            
            const staticTwitter = document.getElementById('static-twitter');
            const staticTwitterCaption = document.getElementById('static-twitter-caption');
            
            const staticYoutube = document.getElementById('static-youtube');
            const staticYoutubeCaption = document.getElementById('static-youtube-caption');
            
            const recentPostsFeed = document.getElementById('recent-posts-feed');
            
            const editModal = document.getElementById('edit-modal');
            const editHeadline = document.getElementById('edit-headline'), editContent = document.getElementById('edit-content'), editTags = document.getElementById('edit-tags');
            const saveEditBtn = document.getElementById('save-edit-btn'), cancelEditBtn = document.getElementById('cancel-edit-btn');
            const countrySearchInput = document.getElementById('country-search-input'), countryContainer = document.getElementById('country-suggestions-container');

            let currentEditingPostId = null;
            let activeContentEditable = null;
            let activeTableBlockId = null;

            // --- AUTO-GROW FOR STATIC TEXTAREAS ---
            function autoResize(el) {
                el.style.height = 'auto';
                el.style.height = el.scrollHeight + 'px';
            }
            staticHeadline.addEventListener('input', function() { autoResize(this); saveDraft(); });
            staticContent.addEventListener('input', function() { autoResize(this); saveDraft(); });
            
            // Added listeners for new inputs to trigger autosave
            [staticImage, staticImageCaption, staticTwitter, staticTwitterCaption, staticYoutube, staticYoutubeCaption].forEach(el => {
                el.addEventListener('input', saveDraft);
            });

            // --- TABLE HISTORY ---
            const tableHistory = {}; 
            function initTableHistory(blockId) {
                tableHistory[blockId] = { undo: [], redo: [], timeout: null };
                setTimeout(() => saveTableState(blockId, true), 50);
            }
            function saveTableState(blockId, isInitialState = false) {
                if (!tableHistory[blockId]) return;
                const history = tableHistory[blockId];
                const block = document.getElementById(blockId);
                if (!block || block.classList.contains('restoring-state')) return;
                const theadHtml = block.querySelector('.sheet-head').innerHTML;
                const tbodyHtml = block.querySelector('.sheet-body').innerHTML;
                const stateSnapshot = { thead: theadHtml, tbody: tbodyHtml };
                if (isInitialState) { history.undo.push(stateSnapshot); } 
                else {
                    const lastState = history.undo[history.undo.length - 1];
                    if (lastState && lastState.thead === theadHtml && lastState.tbody === tbodyHtml) return;
                    history.undo.push(stateSnapshot); history.redo = []; 
                }
                updateHistoryButtons(blockId); saveDraft();
            }
            function undoTable(blockId) {
                const history = tableHistory[blockId];
                if (!history || history.undo.length <= 1) return;
                const block = document.getElementById(blockId);
                block.classList.add('restoring-state');
                history.redo.push(history.undo.pop());
                const previous = history.undo[history.undo.length - 1];
                applyTableState(blockId, previous);
                block.classList.remove('restoring-state');
                updateHistoryButtons(blockId); saveDraft();
            }
            function redoTable(blockId) {
                const history = tableHistory[blockId];
                if (!history || history.redo.length === 0) return;
                const block = document.getElementById(blockId);
                block.classList.add('restoring-state');
                const next = history.redo.pop();
                history.undo.push(next);
                applyTableState(blockId, next);
                block.classList.remove('restoring-state');
                updateHistoryButtons(blockId); saveDraft();
            }
            function applyTableState(blockId, state) {
                const block = document.getElementById(blockId);
                block.querySelector('.sheet-head').innerHTML = state.thead;
                block.querySelector('.sheet-body').innerHTML = state.tbody;
            }
            function updateHistoryButtons(blockId) {
                const history = tableHistory[blockId];
                if (!history) return;
                const undoBtn = document.getElementById(`btn-undo-${blockId}`);
                const redoBtn = document.getElementById(`btn-redo-${blockId}`);
                if (undoBtn) undoBtn.disabled = (history.undo.length <= 1);
                if (redoBtn) redoBtn.disabled = (history.redo.length === 0);
            }

            // ONLY DYNAMIC BLOCKS ARE SORTABLE
            Sortable.create(blocksContainer, {
                animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: saveDraft
            });

            renderCountries();

            // --- AUTO-SAVE ---
            function saveDraft() {
                const blocks = [];
                // Only saving dynamic blocks here
                document.querySelectorAll('.dynamic-content-block').forEach(block => {
                    const type = block.dataset.blockType;
                    if (type === 'table') {
                        const thead = block.querySelector('.sheet-head').innerHTML;
                        const tbody = block.querySelector('.sheet-body').innerHTML;
                        const caption = block.querySelector('.table-caption-input').value;
                        const theme = block.querySelector('.table-theme').value;
                        const sortable = block.querySelector('.table-sortable').checked;
                        blocks.push({ type: 'table', thead, tbody, caption, theme, sortable });
                    } else {
                        const inputs = block.querySelectorAll('textarea, input');
                        blocks.push({
                            type: type,
                            mainValue: inputs[0]?.value || '',
                            descValue: inputs[1]?.value || ''
                        });
                    }
                });
                
                const draftData = { 
                    staticHeadline: staticHeadline.value, 
                    staticContent: staticContent.value,
                    // SAVE NEW FIELDS
                    staticImage: staticImage.value,
                    staticImageCaption: staticImageCaption.value,
                    staticTwitter: staticTwitter.value,
                    staticTwitterCaption: staticTwitterCaption.value,
                    staticYoutube: staticYoutube.value,
                    staticYoutubeCaption: staticYoutubeCaption.value,
                    tags: tagsInput.value, 
                    blocks: blocks, 
                    timestamp: Date.now() 
                };
                localStorage.setItem('cms_autosave_draft', JSON.stringify(draftData));
            }

            function loadDraft() {
                const saved = localStorage.getItem('cms_autosave_draft');
                if (!saved) { resetEditor(); return; }
                try {
                    const draft = JSON.parse(saved);
                    blocksContainer.innerHTML = '';
                    
                    if (draft.staticHeadline) staticHeadline.value = draft.staticHeadline;
                    if (draft.staticContent) staticContent.value = draft.staticContent;
                    
                    // LOAD NEW FIELDS
                    if (draft.staticImage) staticImage.value = draft.staticImage;
                    if (draft.staticImageCaption) staticImageCaption.value = draft.staticImageCaption;
                    if (draft.staticTwitter) staticTwitter.value = draft.staticTwitter;
                    if (draft.staticTwitterCaption) staticTwitterCaption.value = draft.staticTwitterCaption;
                    if (draft.staticYoutube) staticYoutube.value = draft.staticYoutube;
                    if (draft.staticYoutubeCaption) staticYoutubeCaption.value = draft.staticYoutubeCaption;

                    if (draft.tags) tagsInput.value = draft.tags;

                    autoResize(staticHeadline);
                    autoResize(staticContent);

                    if (draft.blocks && draft.blocks.length > 0) {
                        draft.blocks.forEach(blockData => {
                            // MIGRATION: Old drafts handling
                            if (blockData.type === 'headline') {
                                if (!staticHeadline.value) { staticHeadline.value = blockData.mainValue; autoResize(staticHeadline); }
                                return;
                            }
                            if (blockData.type === 'content' && !staticContent.value) {
                                staticContent.value = blockData.mainValue; autoResize(staticContent);
                                return;
                            }
                            
                            createBlock(blockData.type, false, blockData);
                        });
                    }
                } catch (e) { resetEditor(); }
            }

            function clearDraft() { localStorage.removeItem('cms_autosave_draft'); }
            function resetEditor() {
                blocksContainer.innerHTML = '';
                staticHeadline.value = '';
                staticContent.value = '';
                
                // RESET NEW FIELDS
                staticImage.value = '';
                staticImageCaption.value = '';
                staticTwitter.value = '';
                staticTwitterCaption.value = '';
                staticYoutube.value = '';
                staticYoutubeCaption.value = '';

                staticHeadline.style.height = 'auto';
                staticContent.style.height = 'auto';
                tagsInput.value = 'BREAKING, TMP NEWS';
                saveDraft();
            }

            // --- BLOCK CREATION (DYNAMIC ONLY) ---
            function createBlock(type, triggerSave = true, data = null) {
                const blockId = `block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const blockWrapper = document.createElement('div');
                blockWrapper.className = 'dynamic-content-block';
                blockWrapper.id = blockId;
                blockWrapper.dataset.blockType = type;
                
                // Add Drag Handle and Remove Button
                let innerHTML = `
                    <div class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-lines"></i></div>
                    <button class="remove-block-btn" onclick="this.closest('.dynamic-content-block').remove(); saveDraft();"><i class="fas fa-times"></i></button>
                `;

                const inputClass = "w-full p-3 border border-slate-300 rounded-lg bg-white text-sm mt-2";
                const descInput = `<input type="text" class="${inputClass}" placeholder="Caption / Description (optional)" value="${data ? data.descValue : ''}">`;
                
                let mainEl = '';
                let mainVal = data ? data.mainValue : '';

                if (type === 'table') {
                    innerHTML += `
                        <h3 class="text-xs font-bold uppercase text-slate-400 mb-2">Data Table</h3>
                        <div class="setup-stage ${data ? 'hidden' : ''} flex gap-2 mb-4">
                            <input type="number" class="row-input border p-2 rounded w-16 text-sm" value="3" placeholder="Rows">
                            <input type="number" class="col-input border p-2 rounded w-16 text-sm" value="3" placeholder="Cols">
                            <button onclick="createTable('${blockId}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">Create</button>
                            <button onclick="tableCmd('openPaste','${blockId}')" class="bg-emerald-600 text-white px-3 py-1 rounded text-sm">Paste Excel</button>
                        </div>
                        <div class="editor-stage ${data ? '' : 'hidden'}">
                            <div class="table-settings-container">
                                <input type="text" class="table-caption-input" placeholder="Table Caption (Source...)" value="${data ? (data.caption||'') : ''}">
                                <div class="table-footer-options">
                                    <select class="table-theme border border-slate-300 p-1 rounded text-xs">
                                        <option value="" ${data && !data.theme ? 'selected':''}>Default Theme</option>
                                        <option value="striped" ${data && data.theme === 'striped' ? 'selected':''}>Striped</option>
                                        <option value="grid" ${data && data.theme === 'grid' ? 'selected':''}>Grid Border</option>
                                    </select>
                                    <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-500">
                                        <input type="checkbox" class="table-sortable" ${data && data.sortable ? 'checked':''}> Sortable
                                    </label>
                                </div>
                            </div>
                            <div class="table-toolbar-container">
                                <div class="table-toolbar-row">
                                    <div class="table-tool-group border-r-2 border-indigo-100 pr-4">
                                        <button id="btn-undo-${blockId}" class="tool-btn" onclick="tableCmd('undo', '${blockId}')" title="Undo"><i class="fas fa-undo"></i></button>
                                        <button id="btn-redo-${blockId}" class="tool-btn" onclick="tableCmd('redo', '${blockId}')" title="Redo"><i class="fas fa-redo"></i></button>
                                    </div>
                                    <div class="table-tool-group">
                                        <button class="tool-btn" onclick="tableCmd('bold', '${blockId}')"><i class="fas fa-bold"></i></button>
                                        <button class="tool-btn" onclick="tableCmd('italic', '${blockId}')"><i class="fas fa-italic"></i></button>
                                        <button class="tool-btn" onclick="tableCmd('underline', '${blockId}')"><i class="fas fa-underline"></i></button>
                                    </div>
                                    <div class="table-tool-group">
                                        <button class="tool-btn" onclick="tableCmd('justifyLeft', '${blockId}')"><i class="fas fa-align-left"></i></button>
                                        <button class="tool-btn" onclick="tableCmd('justifyCenter', '${blockId}')"><i class="fas fa-align-center"></i></button>
                                        <button class="tool-btn" onclick="tableCmd('justifyRight', '${blockId}')"><i class="fas fa-align-right"></i></button>
                                    </div>
                                    <div class="table-tool-group">
                                        <div class="color-picker-wrapper tool-btn">
                                            <i class="fas fa-fill-drip mr-1"></i>
                                            <input type="color" onchange="tableCmd('hiliteColor','${blockId}',this.value)">
                                        </div>
                                    </div>
                                    <div class="table-tool-group">
                                        <button class="tool-btn" onclick="tableCmd('formatBlock', '${blockId}', '<h1>')">H1</button>
                                        <button class="tool-btn" onclick="tableCmd('formatBlock', '${blockId}', '<h2>')">H2</button>
                                    </div>
                                </div>
                                <div class="table-toolbar-row">
                                    <div class="table-tool-group">
                                        <button class="tool-btn text-indigo-600" onclick="tableCmd('addRow', '${blockId}')"><i class="fas fa-plus"></i> Row</button>
                                        <button class="tool-btn text-indigo-600" onclick="tableCmd('addCol', '${blockId}')"><i class="fas fa-plus"></i> Col</button>
                                    </div>
                                    <div class="table-tool-group">
                                        <button class="tool-btn" onclick="tableCmd('mergeRight', '${blockId}')"><i class="fas fa-arrows-alt-h"></i></button>
                                        <button class="tool-btn" onclick="tableCmd('mergeDown', '${blockId}')"><i class="fas fa-arrows-alt-v"></i></button>
                                    </div>
                                    <div class="table-tool-group">
                                        <button class="tool-btn text-red-500" onclick="tableCmd('delRow', '${blockId}')"><i class="fas fa-trash"></i></button>
                                        <button class="tool-btn text-red-500" onclick="tableCmd('delCol', '${blockId}')"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="table-wrapper"><table class="sheet-table"><thead class="sheet-head">${data ? data.thead : ''}</thead><tbody class="sheet-body">${data ? data.tbody : ''}</tbody></table></div>
                        </div>
                    `;
                } else {
                    let title = type.replace(/-/g, ' ').toUpperCase();
                    innerHTML += `<h3 class="text-xs font-bold uppercase text-slate-400 mb-2">${title}</h3>`;
                    
                    switch (type) {
                        case 'content': mainEl = `<textarea rows="4" class="${inputClass}" placeholder="Write additional paragraph...">${mainVal}</textarea>`; break;
                        case 'quote': mainEl = `<textarea rows="2" class="${inputClass} italic" placeholder="Quote text...">${mainVal}</textarea>`; break;
                        case 'image': mainEl = `<input type="text" class="${inputClass}" placeholder="Image URL" value="${mainVal}">${descInput}`; break;
                        case 'link-button': mainEl = `<input type="text" class="${inputClass}" placeholder="Link URL" value="${mainVal}">${descInput.replace('Caption', 'Button Label')}`; break;
                        default: mainEl = `<input type="text" class="${inputClass}" placeholder="Embed Code or URL" value="${mainVal}">${descInput}`; break;
                    }
                    innerHTML += mainEl;
                }

                blockWrapper.innerHTML = innerHTML;
                blocksContainer.appendChild(blockWrapper);
                
                blockWrapper.querySelectorAll('textarea, input').forEach(el => {
                    if(el.tagName==='TEXTAREA') { 
                        el.addEventListener('input', function() { autoResize(this); });
                        if(data) autoResize(el);
                    }
                    el.addEventListener('input', saveDraft);
                });
                
                if(type === 'table') {
                    blockWrapper.addEventListener('focusin', (e) => { if(e.target.classList.contains('sheet-cell')) activeContentEditable = e.target; });
                    initTableHistory(blockId);
                }

                if(triggerSave) saveDraft();
            }

            // --- TABLE LOGIC ---
            window.createTable = function(id) {
                const block = document.getElementById(id);
                const rows = parseInt(block.querySelector('.row-input').value)||2;
                const cols = parseInt(block.querySelector('.col-input').value)||2;
                block.querySelector('.setup-stage').classList.add('hidden');
                block.querySelector('.editor-stage').classList.remove('hidden');
                let headHtml = '<tr>'; for(let c=0; c<cols; c++) headHtml += `<td><div contenteditable="true" class="sheet-cell" data-placeholder="Head"></div></td>`; headHtml += '</tr>';
                block.querySelector('.sheet-head').innerHTML = headHtml;
                let bodyHtml = ''; for(let r=1; r<rows; r++) { bodyHtml += '<tr>'; for(let c=0; c<cols; c++) bodyHtml += `<td><div contenteditable="true" class="sheet-cell" data-placeholder="Data"></div></td>`; bodyHtml += '</tr>'; }
                block.querySelector('.sheet-body').innerHTML = bodyHtml;
                initTableHistory(id); saveDraft();
            };

            window.tableCmd = function(cmd, id, arg=null) {
                const block = document.getElementById(id);
                if(!block) return;
                
                if(cmd === 'undo') { undoTable(id); return; }
                if(cmd === 'redo') { redoTable(id); return; }
                if(cmd === 'openPaste') { activeTableBlockId = id; document.getElementById('paste-input').value=''; document.getElementById('paste-modal').classList.remove('hidden'); return; }

                if(['addRow','addCol','delRow','delCol','mergeRight','mergeDown','bold','italic','underline','justifyLeft','justifyCenter','justifyRight','hiliteColor','formatBlock'].includes(cmd)) { saveTableState(id); }

                if(['bold','italic','underline','justifyLeft','justifyCenter','justifyRight','removeFormat','formatBlock'].includes(cmd)) {
                    if(activeContentEditable && block.contains(activeContentEditable)) {
                        if(cmd.startsWith('justify')) activeContentEditable.parentElement.style.textAlign = cmd.replace('justify','').toLowerCase();
                        else document.execCommand(cmd, false, arg);
                        activeContentEditable.focus();
                    }
                    saveDraft(); return;
                }

                if(cmd === 'hiliteColor') { if(activeContentEditable && block.contains(activeContentEditable)) activeContentEditable.parentElement.style.backgroundColor = arg; saveDraft(); return; }

                if(cmd === 'mergeRight' || cmd === 'mergeDown') {
                    if(!activeContentEditable) return;
                    const td = activeContentEditable.parentElement;
                    if(cmd === 'mergeRight') {
                        const nextTd = td.nextElementSibling;
                        if(nextTd) {
                            td.setAttribute('colspan', (parseInt(td.getAttribute('colspan')||1)) + (parseInt(nextTd.getAttribute('colspan')||1)));
                            if(nextTd.innerText) activeContentEditable.innerHTML += ' ' + nextTd.innerText;
                            nextTd.remove();
                        }
                    } else {
                        const tr = td.parentElement;
                        const nextTr = tr.nextElementSibling;
                        if(nextTr) {
                            const idx = Array.from(tr.children).indexOf(td);
                            const targetTd = nextTr.children[idx];
                            if(targetTd) {
                                td.setAttribute('rowspan', (parseInt(td.getAttribute('rowspan')||1)) + (parseInt(targetTd.getAttribute('rowspan')||1)));
                                if(targetTd.innerText) activeContentEditable.innerHTML += '<br>' + targetTd.innerText;
                                targetTd.remove();
                            }
                        }
                    }
                    saveDraft(); return;
                }

                const tbody = block.querySelector('.sheet-body');
                const headRow = block.querySelector('.sheet-head tr');

                if (cmd === 'addRow') {
                    let cols = 0; Array.from(headRow.children).forEach(td => cols += parseInt(td.getAttribute('colspan')||1));
                    const tr = document.createElement('tr'); for(let i=0; i<cols; i++) tr.innerHTML += `<td><div contenteditable="true" class="sheet-cell"></div></td>`;
                    tbody.appendChild(tr);
                }
                if (cmd === 'addCol') {
                    headRow.innerHTML += `<td><div contenteditable="true" class="sheet-cell"></div></td>`;
                    tbody.querySelectorAll('tr').forEach(tr => tr.innerHTML += `<td><div contenteditable="true" class="sheet-cell"></div></td>`);
                }
                if (cmd === 'delRow') {
                    if(activeContentEditable && block.contains(activeContentEditable)) { const tr = activeContentEditable.closest('tr'); if(tr && tr.parentElement === tbody) tr.remove(); }
                    else if(tbody.children.length > 0) tbody.removeChild(tbody.lastElementChild);
                }
                if (cmd === 'delCol') {
                      if(headRow.children.length > 1) {
                        headRow.removeChild(headRow.lastElementChild);
                        tbody.querySelectorAll('tr').forEach(tr => { if(tr.children.length > 0) tr.removeChild(tr.lastElementChild); });
                    }
                }
                saveDraft();
            };

            document.getElementById('confirm-paste-btn').onclick = () => {
                const data = document.getElementById('paste-input').value;
                const rows = data.trim().split('\n');
                let html = '';
                rows.forEach(row => {
                    html += '<tr>'; row.split('\t').forEach(cell => html += `<td><div contenteditable="true" class="sheet-cell">${cell.trim()}</div></td>`); html += '</tr>';
                });
                document.querySelector(`#${activeTableBlockId} .sheet-body`).innerHTML = html;
                document.getElementById('paste-modal').classList.add('hidden');
                saveTableState(activeTableBlockId);
            };

            function renderCountries(filter = '') {
                countryContainer.innerHTML = '';
                oicCountriesList.filter(c => c.toLowerCase().includes(filter.toLowerCase())).forEach(c => {
                    const chip = document.createElement('div');
                    chip.className = 'country-chip'; chip.textContent = c;
                    chip.onclick = () => { tagsInput.value += `, ${c.toLowerCase().replace(/\s/g, '-')}`; saveDraft(); };
                    countryContainer.appendChild(chip);
                });
            }
            countrySearchInput.addEventListener('input', (e) => renderCountries(e.target.value));
            
            document.querySelectorAll('.tag-chip').forEach(chip => {
                chip.onclick = () => { tagsInput.value += `, ${chip.dataset.tag}`; saveDraft(); };
            });

            addBlockBtn.addEventListener('click', () => createBlock(blockTypeSelect.value));
            
            tagsInput.addEventListener('input', saveDraft);

            document.getElementById('show-sign-up').onclick = (e) => { e.preventDefault(); signInForm.classList.add('hidden'); signUpForm.classList.remove('hidden'); };
            document.getElementById('show-sign-in').onclick = (e) => { e.preventDefault(); signUpForm.classList.add('hidden'); signInForm.classList.remove('hidden'); };
            document.querySelectorAll('.toggle-password').forEach(icon => {
                icon.onclick = () => {
                    const input = document.getElementById(icon.dataset.target);
                    input.type = input.type === 'password' ? 'text' : 'password';
                    icon.classList.toggle('fa-eye'); icon.classList.toggle('fa-eye-slash');
                };
            });

            publishButton.addEventListener('click', async () => {
                publishButton.disabled = true;
                document.getElementById("publish-spinner").classList.remove("hidden");
                
                const headline = staticHeadline.value.trim();
                const mainContent = staticContent.value.trim();
                const blocks = Array.from(document.querySelectorAll('.dynamic-content-block'));
                
                // VALIDATION
                if (!headline && !mainContent && blocks.length === 0 && !staticImage.value && !staticTwitter.value && !staticYoutube.value) {
                    statusMessage.textContent = 'Post cannot be completely empty!'; 
                    statusMessage.className = 'text-center mt-4 text-sm font-bold text-red-600';
                    publishButton.disabled = false;
                    document.getElementById("publish-spinner").classList.add("hidden");
                    return;
                }

                let bodyParts = [];
                // 1. ADD STATIC CONTENT
                if (mainContent) bodyParts.push(mainContent);

                // 2. ADD NEW STATIC LINKS (formatted with Captions)
                if (staticImage.value.trim()) {
                    const imgCap = staticImageCaption.value.trim() || 'Featured Image';
                    bodyParts.push(`![${imgCap}](${staticImage.value.trim()})`);
                }
                if (staticTwitter.value.trim()) {
                    const twitCap = staticTwitterCaption.value.trim() || 'Featured Video';
                    bodyParts.push(`[twitter-video|${twitCap}](${staticTwitter.value.trim()})`);
                }
                if (staticYoutube.value.trim()) {
                    const ytCap = staticYoutubeCaption.value.trim() || 'Featured Video';
                    bodyParts.push(`[youtube|${ytCap}](${staticYoutube.value.trim()})`);
                }

                // 3. ADD DYNAMIC BLOCKS
                blocks.forEach(block => {
                    const type = block.dataset.blockType;
                    if (type === 'table') {
                        const caption = block.querySelector('.table-caption-input').value;
                        const theme = block.querySelector('.table-theme').value;
                        const sortable = block.querySelector('.table-sortable').checked ? 'sortable' : '';
                        const tableHTML = `<div class="table-container ${theme} ${sortable}">` + (caption ? `<caption>${caption}</caption>` : '') + `<table class="live-table"><thead>${block.querySelector('.sheet-head').innerHTML}</thead>` + `<tbody>${block.querySelector('.sheet-body').innerHTML}</tbody></table></div>`;
                        bodyParts.push(tableHTML);
                    } else {
                        const inputs = block.querySelectorAll('textarea, input');
                        const val = inputs[0]?.value.trim();
                        const desc = inputs[1]?.value.trim();
                        if (!val) return;
                        switch (type) {
                            case 'content': bodyParts.push(val); break;
                            case 'quote': bodyParts.push(`> ${val.replace(/\n/g, '\n> ')}`); break;
                            case 'image': bodyParts.push(`![${desc}](${val})`); break;
                            case 'link-button': bodyParts.push(`[link-button|${desc}](${val})`); break;
                            case 'twitter': bodyParts.push(`[twitter|${desc}](${val})`); break;
                            case 'twitter-video': bodyParts.push(`[twitter-video|${desc}](${val})`); break;
                            default: bodyParts.push(`[${type}|${desc}](${val})`); break;
                        }
                    }
                });

                const content = bodyParts.join('\n\n');
                const tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);

                const { data: { user } } = await supabaseClient.auth.getUser();
                if(user) {
                    const { error } = await supabaseClient.from('live_posts').insert({ headline, content, user_id: user.id, tags });
                    if (!error) {
                        statusMessage.textContent = 'Published!'; statusMessage.className = 'text-center mt-4 text-sm font-bold text-green-600';
                        clearDraft(); resetEditor();
                    } else {
                        statusMessage.textContent = error.message; statusMessage.className = 'text-center mt-4 text-sm font-bold text-red-600';
                    }
                }
                
                publishButton.disabled = false;
                document.getElementById("publish-spinner").classList.add("hidden");
                setTimeout(() => statusMessage.textContent = '', 3000);
            });

            signInForm.onsubmit = async (e) => {
                e.preventDefault();
                const { error } = await supabaseClient.auth.signInWithPassword({ 
                    email: document.getElementById('sign-in-email').value, 
                    password: document.getElementById('sign-in-password').value 
                });
                if(error) { authMessage.textContent = error.message; authMessage.style.color='red'; }
            };

            signUpForm.onsubmit = async (e) => {
                e.preventDefault();
                const { error, data } = await supabaseClient.auth.signUp({ 
                    email: document.getElementById('sign-up-email').value, 
                    password: document.getElementById('sign-up-password').value 
                });
                if(error) { authMessage.textContent = error.message; authMessage.style.color='red'; }
                else if(data.user) { authMessage.textContent = 'Check email for link!'; authMessage.style.color='green'; }
            };

            logoutButton.onclick = async () => await supabaseClient.auth.signOut();

            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    authView.classList.add('hidden'); editorView.classList.remove('hidden');
                    document.getElementById('writer-email').textContent = session.user.email;
                    if(blocksContainer.children.length === 0) loadDraft();
                    fetchRecentPosts();
                } else {
                    authView.classList.remove('hidden'); editorView.classList.add('hidden');
                }
            });

            async function fetchRecentPosts() {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if(!user) return;
                const { data } = await supabaseClient.from('live_posts').select('*').eq('user_id', user.id).order('timestamp', { ascending: false }).limit(10);
                recentPostsFeed.innerHTML = '';
                if(data) data.forEach(post => {
                    const div = document.createElement('div');
                    div.className = "p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors rounded-lg group";
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-sm text-slate-800 line-clamp-1">${post.headline || 'No Headline'}</p>
                                <p class="text-xs text-slate-400 mt-1">${new Date(post.timestamp).toLocaleTimeString()}</p>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="text-xs text-blue-600 font-bold edit-btn" data-id="${post.id}">Edit</button>
                                <button class="text-xs text-red-600 font-bold delete-btn" data-id="${post.id}">Del</button>
                            </div>
                        </div>`;
                    recentPostsFeed.appendChild(div);
                });
            }

            recentPostsFeed.addEventListener('click', async (e) => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (e.target.classList.contains('delete-btn')) {
                    if(confirm('Delete post?')) {
                        await supabaseClient.from('live_posts').delete().match({ id: e.target.dataset.id, user_id: user.id });
                        fetchRecentPosts();
                    }
                }
                if (e.target.classList.contains('edit-btn')) {
                    const { data } = await supabaseClient.from('live_posts').select('*').eq('id', e.target.dataset.id).single();
                    if(data) {
                        currentEditingPostId = data.id;
                        editHeadline.value = data.headline;
                        editContent.value = data.content;
                        editTags.value = data.tags ? data.tags.join(', ') : '';
                        editModal.classList.remove('hidden');
                        editModal.classList.add('flex');
                    }
                }
            });

            const closeEdit = () => { editModal.classList.add('hidden'); editModal.classList.remove('flex'); };
            document.getElementById('cancel-edit-btn').onclick = closeEdit;
            document.getElementById('cancel-edit-btn-x').onclick = closeEdit;
            saveEditBtn.onclick = async () => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const tags = editTags.value.split(',').map(t => t.trim()).filter(Boolean);
                await supabaseClient.from('live_posts').update({ 
                    headline: editHeadline.value, content: editContent.value, tags 
                }).match({ id: currentEditingPostId, user_id: user.id });
                closeEdit();
                fetchRecentPosts();
            };
        });
    </script>
</body>
</html>
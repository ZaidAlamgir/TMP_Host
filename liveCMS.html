<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Content CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        #edit-modal.open { display: flex; }
        #edit-modal-content { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        textarea { resize: none; overflow: hidden; }
        textarea.quote-input { font-style: italic; }
        .content-block { 
            /* Styles for the editor blocks */
            border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem;
            margin-top: 1.5rem; background-color: #f8fafc; position: relative;
        }
        .password-wrapper { 
            position: relative;
        }
        .toggle-password {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9ca3af; 
            transition: color 0.2s;
        }
        .toggle-password:hover {
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="w-full min-h-screen">
        <!-- AUTHENTICATION VIEW -->
        <div id="auth-view" class="flex items-center justify-center min-h-screen p-4">
             <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md mx-auto">
                 <form id="sign-in-form">
                     <h1 class="text-3xl font-bold mb-6 text-center">Writer CMS Login</h1>
                     <div class="mb-4">
                        <label for="sign-in-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="sign-in-email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                     </div>
                     <div class="mb-6">
                        <label for="sign-in-password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                         <div class="password-wrapper">
                             <input type="password" id="sign-in-password" class="w-full p-3 border border-slate-300 rounded-lg" required data-target="sign-in-password">
                             <i class="fas fa-eye-slash toggle-password" data-target="sign-in-password"></i>
                         </div>
                     </div>
                     <button type="submit" class="bg-slate-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 w-full">Sign In</button>
                     <p class="text-sm text-center text-slate-600 mt-4">Don't have an account? <a href="#" id="show-sign-up" class="font-semibold text-blue-600 hover:underline">Sign Up</a></p>
                 </form>

                 <form id="sign-up-form" class="hidden">
                     <h1 class="text-3xl font-bold mb-6 text-center">Create Writer Account</h1>
                     <div class="mb-4">
                        <label for="sign-up-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="sign-up-email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                     </div>
                     <div class="mb-6">
                        <label for="sign-up-password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                         <div class="password-wrapper">
                             <input type="password" id="sign-up-password" class="w-full p-3 border border-slate-300 rounded-lg" required data-target="sign-up-password">
                             <i class="fas fa-eye-slash toggle-password" data-target="sign-up-password"></i>
                         </div>
                     </div>
                     <button type="submit" class="bg-slate-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 w-full">Sign Up</button>
                     <p class="text-sm text-center text-slate-600 mt-4">Already have an account? <a href="#" id="show-sign-in" class="font-semibold text-blue-600 hover:underline">Sign In</a></p>
                 </form>
                 
                 <p id="auth-message" class="text-center mt-4 text-sm font-medium"></p>
             </div>
        </div>

        <!-- EDITOR VIEW -->
        <div id="editor-view" class="hidden">
             <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-20">
                 <h1 class="text-xl font-bold">Live CMS</h1>
                 <div class="flex items-center gap-4">
                    <span id="writer-email" class="text-sm text-slate-500 hidden md:block"></span>
                    <button id="logout-button" class="text-sm font-semibold text-slate-600 hover:text-red-500">Logout</button>
                </div>
             </header>
             <main class="w-full max-w-screen-2xl mx-auto p-4 md:p-8 lg:grid lg:grid-cols-12 lg:gap-8">
                 <div class="lg:col-span-7 mb-8 lg:mb-0">
                     <div class="bg-white p-6 rounded-2xl shadow-lg">
                         <h2 class="text-2xl font-bold mb-6">Create New Update</h2>
                         <div id="content-blocks-container"></div>
                         <div class="mt-6">
                            <label for="tags-input" class="block text-sm font-medium text-slate-700 mb-1">Tags (optional)</label>
                            <input type="text" id="tags-input" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="e.g. politics, sports, breaking-news">
                        </div>
                         <div class="mt-6 flex items-center gap-4 p-4 bg-slate-50 rounded-lg">
                             <select id="block-type-select" class="flex-grow p-3 border border-slate-300 rounded-lg">
                                 <option value="headline">Headline</option>
                                 <option value="content">Paragraph</option>
                                 <option value="image">Image</option>
                                 <option value="quote">Quote</option>
                                 <optgroup label="Live Widgets & HTML">
                                     <option value="live-score-embed">Live Score/Game (Embed)</option>
                                     <option value="weather-embed">Weather/Map (Embed)</option>
                                     <option value="html-code">Custom HTML/Script</option>
                                 </optgroup>
                                 <optgroup label="Social Media">
                                     <option value="twitter">Twitter</option>
                                     <option value="twitter-video">Twitter (Cleaner)</option>
                                     <option value="instagram">Instagram</option>
                                     <option value="instagram-video">Instagram (Video Only)</option>
                                     <option value="facebook">Facebook</option>
                                     <option value="tiktok">TikTok</option>
                                     <option value="youtube">YouTube</option>
                                     <option value="linkedin">LinkedIn</option>
                                     <option value="reddit">Reddit</option>
                                     <option value="telegram">Telegram</option>
                                 </optgroup>
                             </select>
                             <button id="add-block-button" class="bg-slate-600 text-white font-bold p-3 rounded-lg hover:bg-slate-500"><i class="fas fa-plus"></i></button>
                         </div>
                         <button id="publish-button" class="mt-6 bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-500 w-full flex items-center justify-center text-lg">
                             <span id="publish-text">Publish</span><span id="publish-spinner" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i> Publishing...</span>
                         </button>
                         <p id="status-message" class="text-center mt-4 text-sm"></p>
                     </div>
                 </div>
                 <div class="lg:col-span-5">
                     <div class="bg-white p-6 rounded-2xl shadow-lg sticky top-24">
                        <h2 class="text-2xl font-bold mb-4">Your Recent Posts</h2>
                        <div id="recent-posts-feed" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
                    </div>
                 </div>
             </main>
        </div>

        <!-- EDIT MODAL -->
        <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
             <div id="edit-modal-content" class="bg-white rounded-2xl shadow-lg w-full max-w-2xl flex flex-col max-h-[95vh]">
                 <h2 class="text-2xl font-bold mb-4 p-8 pb-0 flex-shrink-0">Edit Post</h2>
                 <div class="px-8 pb-6 overflow-y-auto">
                     <div class="mb-4">
                        <label for="edit-headline" class="block text-sm font-medium text-slate-700 mb-1">Headline</label>
                        <input type="text" id="edit-headline" class="w-full p-3 border border-slate-300 rounded-lg">
                    </div>
                     <div class="mb-4">
                        <label for="edit-content" class="block text-sm font-medium text-slate-700 mb-1">Content (Markdown)</label>
                        <textarea id="edit-content" class="w-full p-3 border border-slate-300 rounded-lg min-h-[250px] font-mono text-sm"></textarea>
                    </div>
                     <div class="mb-6">
                        <label for="edit-tags" class="block text-sm font-medium text-slate-700 mb-1">Tags</label>
                        <input type="text" id="edit-tags" class="w-full p-3 border border-slate-300 rounded-lg">
                    </div>
                 </div>
                 <div class="flex justify-end gap-4 p-8 pt-0 mt-auto border-t border-slate-200 flex-shrink-0">
                    <button id="cancel-edit-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
                    <button id="save-edit-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Save Changes</button>
                </div>
             </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: Using the Supabase credentials you provided.
            const SUPABASE_URL = 'https://ofszjurrajwtbwlfckhi.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mc3pqdXJyYWp3dGJ3bGZja2hpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDk2MzgsImV4cCI6MjA3NDk4NTYzOH0.kKafp8dEL7V0Y10-oNbjluYblA03a0V_OqB9XOBd9SA';

            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // --- UI Elements ---
            const authView = document.getElementById('auth-view');
            const editorView = document.getElementById('editor-view');
            const signInForm = document.getElementById('sign-in-form');
            const signUpForm = document.getElementById('sign-up-form');
            const logoutButton = document.getElementById('logout-button');
            const authMessage = document.getElementById('auth-message');
            const writerEmailSpan = document.getElementById('writer-email');
            
            const blocksContainer = document.getElementById('content-blocks-container');
            const publishButton = document.getElementById('publish-button');
            const statusMessage = document.getElementById('status-message');
            const addBlockBtn = document.getElementById('add-block-button');
            const blockTypeSelect = document.getElementById('block-type-select');
            const tagsInput = document.getElementById('tags-input');
            const recentPostsFeed = document.getElementById('recent-posts-feed');
            
            const editModal = document.getElementById('edit-modal');
            const editHeadline = document.getElementById('edit-headline');
            const editContent = document.getElementById('edit-content');
            const editTags = document.getElementById('edit-tags');
            const saveEditBtn = document.getElementById('save-edit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            
            let currentEditingPostId = null;

            // --- UI TOGGLES ---
            document.getElementById('show-sign-up').addEventListener('click', (e) => { 
                e.preventDefault(); 
                signInForm.classList.add('hidden'); 
                signUpForm.classList.remove('hidden'); 
                authMessage.textContent = ''; 
            });
            document.getElementById('show-sign-in').addEventListener('click', (e) => { 
                e.preventDefault(); 
                signUpForm.classList.add('hidden'); 
                signInForm.classList.remove('hidden'); 
                authMessage.textContent = ''; 
            });

            // Password Visibility Toggle
            document.querySelectorAll('.toggle-password').forEach(icon => {
                icon.addEventListener('click', () => {
                    const targetId = icon.dataset.target;
                    const passwordField = document.getElementById(targetId);
                    const isPassword = passwordField.type === 'password';
                    passwordField.type = isPassword ? 'text' : 'password';
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            });

            // --- AUTHENTICATION LOGIC (Simplified for direct access) ---
            signInForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                authMessage.textContent = ''; 
                const email = document.getElementById('sign-in-email').value; 
                const password = document.getElementById('sign-in-password').value; 
                
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password }); 
                
                if (error) { 
                    authMessage.textContent = error.message; 
                    authMessage.style.color = 'red'; 
                }
                // If successful, onAuthStateChange handles the view change.
            });
            
            signUpForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                authMessage.textContent = ''; 
                const email = document.getElementById('sign-up-email').value; 
                const password = document.getElementById('sign-up-password').value; 
                
                const { error, data } = await supabaseClient.auth.signUp({ email, password }); 
                
                if (error) { 
                    authMessage.textContent = error.message; 
                    authMessage.style.color = 'red'; 
                } else if (data.user) {
                    authMessage.textContent = 'Account created! Please check your email for a verification link. Sign in now.'; 
                    authMessage.style.color = 'green'; 
                    signUpForm.classList.add('hidden');
                    signInForm.classList.remove('hidden');
                }
            });

            logoutButton.addEventListener('click', async () => { 
                await supabaseClient.auth.signOut(); 
            });

            // *** FIX: REMOVED AUTHORIZATION CHECK (Restores previous behavior) ***
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    // User is successfully logged in. Grant access to editor.
                    authView.classList.add('hidden');
                    editorView.classList.remove('hidden');
                    writerEmailSpan.textContent = session.user.email;
                    
                    // Initialize content blocks if empty
                    if (blocksContainer.children.length === 0) {
                        createBlock('headline');
                        createBlock('image');
                        createBlock('youtube');
                        createBlock('content');
                    }
                    fetchRecentPosts();
                } else {
                    // User is logged out. Show auth view.
                    authView.classList.remove('hidden');
                    editorView.classList.add('hidden');
                }
            });
            // --- END AUTHENTICATION LOGIC ---

            // --- Editor Functions ---

            function autoExpand(textarea) { if (textarea) { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight) + 'px'; } }

            function createBlock(type) {
                const blockId = `block-${Date.now()}`;
                const blockWrapper = document.createElement('div');
                blockWrapper.className = 'content-block bg-slate-50 border border-slate-200 p-6 rounded-xl relative mt-6';
                blockWrapper.id = blockId;
                blockWrapper.dataset.blockType = type;
                let blockTitle = type.replace('-',' ').replace(/\b\w/g, l => l.toUpperCase());
                let innerHTML = `<h3 class="font-bold text-slate-600 uppercase text-sm mb-3">${blockTitle}</h3><button class="absolute top-4 right-4 text-slate-400 hover:text-red-500" onclick="document.getElementById('${blockId}').remove()"><i class="fas fa-times"></i></button>`;
                const inputClasses = "w-full p-3 border border-slate-300 rounded-lg bg-white";
                const textareaClasses = "w-full p-3 border border-slate-300 rounded-lg bg-white";
                const descInput = `<input type="text" class="${inputClasses} mt-2 text-sm" placeholder="Description or Caption (optional)">`;
                let mainEl;

                switch (type) {
                    case 'headline': mainEl = `<textarea rows="1" class="${textareaClasses} font-bold text-2xl" placeholder="Main title of the update"></textarea>`; break;
                    case 'content': mainEl = `<textarea rows="3" class="${textareaClasses}" placeholder="Write the update details..."></textarea>`; break;
                    case 'image': mainEl = `<input type="text" class="${inputClasses}" placeholder="Paste image URL">${descInput}`; break;
                    case 'quote': mainEl = `<textarea rows="2" class="${textareaClasses} quote-input" placeholder="Enter the quote here..."></textarea>`; break;
                    
                    case 'live-score-embed':
                    case 'weather-embed':
                    case 'html-code':
                        mainEl = `<textarea rows="6" class="${textareaClasses} font-mono text-sm" placeholder="Paste the full HTML or iframe embed code here..."></textarea>`;
                        break;

                    default: // Handles all social media embeds
                        mainEl = `<input type="text" class="${inputClasses}" placeholder="Paste full post URL">${descInput}`; break;
                }
                innerHTML += mainEl;
                blockWrapper.innerHTML = innerHTML;
                blocksContainer.appendChild(blockWrapper);
                blockWrapper.querySelectorAll('textarea').forEach(textarea => { textarea.addEventListener('input', () => autoExpand(textarea)); setTimeout(() => autoExpand(textarea), 0); });
            }

            async function fetchRecentPosts() {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;
                const { data, error } = await supabaseClient.from('live_posts').select('*').eq('user_id', user.id).order('timestamp', { ascending: false }).limit(15);
                if (error) { console.error("Error fetching recent posts:", error); return; }
                recentPostsFeed.innerHTML = '';
                if(data) data.forEach(post => renderRecentPost(post));
            }

            function renderRecentPost(post, prepend = false) {
                const postEl = document.createElement('div');
                const isPinned = post.is_pinned;
                postEl.className = `p-4 border rounded-lg flex justify-between items-center ${isPinned ? 'border-yellow-400 bg-yellow-50' : 'border-slate-200'}`;
                postEl.id = `recent-post-${post.id}`;
                const pinButtonHTML = isPinned ? `<button class="pin-btn text-sm font-semibold text-yellow-600" data-post-id="${post.id}"><i class="fas fa-thumbtack mr-1"></i> Unpin</button>` : `<button class="pin-btn text-sm font-semibold text-slate-500 hover:text-slate-800" data-post-id="${post.id}"><i class="fas fa-thumbtack"></i></button>`;
                postEl.innerHTML = `<div><p class="font-semibold">${post.headline || 'Update'}</p><p class="text-xs text-slate-500">${new Date(post.timestamp).toLocaleString()}</p></div><div class="flex items-center gap-3">${pinButtonHTML}<button class="edit-btn text-sm font-semibold text-blue-600" data-post-id="${post.id}">Edit</button><button class="delete-btn text-sm font-semibold text-red-600" data-post-id="${post.id}">Delete</button></div>`;
                if (prepend) { recentPostsFeed.prepend(postEl); } else { recentPostsFeed.appendChild(postEl); }
            }

            // --- Event Listeners ---
            
            addBlockBtn.addEventListener('click', () => createBlock(blockTypeSelect.value));

            recentPostsFeed.addEventListener('click', async (e) => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;
                const target = e.target.closest('.pin-btn, .edit-btn, .delete-btn');
                if (!target) return;
                const postId = target.dataset.postId;
                
                if (target.classList.contains('pin-btn')) {
                    const { data, error } = await supabaseClient.rpc('toggle_pin', { post_id_to_toggle: postId, user_id_of_pinner: user.id });
                    if (error) { 
                        // Using console.error for non-critical errors inside game/app to avoid blocking
                        console.error(`RPC Error: ${error.message}`); 
                    }
                    else if (data && data.startsWith('Error:')) { 
                        console.error(data); 
                    }
                } else if (target.classList.contains('delete-btn')) {
                    // IMPORTANT: Replace alert/confirm with a custom modal in a production app.
                    if (window.confirm('Are you sure you want to delete this post?')) {
                        const { error } = await supabaseClient.from('live_posts').delete().match({ id: postId, user_id: user.id });
                        if (error) console.error(`Error deleting post: ${error.message}`);
                    }
                } else if (target.classList.contains('edit-btn')) {
                    const { data, error } = await supabaseClient.from('live_posts').select('*').eq('id', postId).single();
                    if (data) { 
                        currentEditingPostId = postId; 
                        editHeadline.value = data.headline; 
                        editContent.value = data.content; 
                        editTags.value = data.tags ? data.tags.join(', ') : ''; 
                        editModal.classList.add('open'); 
                        setTimeout(() => autoExpand(editContent), 50); 
                    }
                }
            });

            // Edit Modal Handlers
            editContent.addEventListener('input', () => autoExpand(editContent));
            cancelEditBtn.addEventListener('click', () => editModal.classList.remove('open'));

            saveEditBtn.addEventListener('click', async () => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!currentEditingPostId || !user) return;
                const updatedTags = editTags.value.split(',').map(t => t.trim()).filter(Boolean);
                const { error } = await supabaseClient.from('live_posts').update({ 
                    headline: editHeadline.value, 
                    content: editContent.value, 
                    tags: updatedTags 
                }).match({ id: currentEditingPostId, user_id: user.id });
                
                if (error) { 
                    console.error(`Error saving changes: ${error.message}`); 
                } else { 
                    editModal.classList.remove('open'); 
                }
            });

            // Publishing Logic
            const setPublishingState = (isPublishing) => { 
                publishButton.disabled = isPublishing; 
                document.getElementById("publish-text").classList.toggle("hidden", isPublishing); 
                document.getElementById("publish-spinner").classList.toggle("hidden", !isPublishing); 
            };
            
            publishButton.addEventListener('click', async () => {
                setPublishingState(true);
                const blocks = Array.from(document.querySelectorAll('.content-block'));
                let headline = '', bodyParts = [];
                
                blocks.forEach(block => {
                    const type = block.dataset.blockType;
                    const inputs = block.querySelectorAll('textarea, input');
                    const mainValue = inputs[0]?.value.trim();
                    const descValue = inputs[1]?.value.trim();
                    if (!mainValue) return;

                    switch (type) {
                        case 'headline': headline = mainValue; break;
                        case 'content': bodyParts.push(mainValue); break;
                        case 'quote': bodyParts.push(`> ${mainValue.replace(/\n/g, '\n> ')}`); break;
                        case 'image':
                            bodyParts.push(`![${descValue || 'Image'}](${mainValue})`); break;
                        
                        case 'live-score-embed':
                        case 'weather-embed':
                        case 'html-code':
                            // Uses a custom tag format to embed raw HTML on the reader side
                            bodyParts.push(`[WIDGET|${type}|${descValue || ''}]${mainValue}`); 
                            break;
                            
                        default: // Handles all social media types by using their 'type' name as the keyword
                            bodyParts.push(`[${type}|${descValue || ''}](${mainValue})`); break;
                    }
                });
                
                const tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
                const content = bodyParts.join('\n\n');
                
                if (!content && !headline) { 
                    console.warn("Cannot publish an empty update."); 
                    statusMessage.textContent = "Cannot publish an empty update.";
                    statusMessage.style.color = 'orange';
                    setPublishingState(false); 
                    return; 
                }
                
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                // Assuming RLS policy on live_posts allows insert for authenticated user
                const { error } = await supabaseClient.from('live_posts').insert({ headline, content, user_id: user.id, tags });
                
                if (error) { 
                    statusMessage.textContent = `Error: ${error.message}.`; 
                    statusMessage.style.color = 'red'; 
                }
                else {
                    statusMessage.textContent = 'Successfully published!';
                    statusMessage.style.color = 'green';
                    blocksContainer.innerHTML = '';

                    // Reset the form to the new default state after publishing
                    createBlock('headline');
                    createBlock('image');
                    createBlock('youtube');
                    createBlock('content');

                    tagsInput.value = '';
                }
                setPublishingState(false);

                // Clear status message after 3 seconds
                setTimeout(() => { statusMessage.textContent = '', statusMessage.style.color = ''; }, 3000);
            });

            // Realtime listener for post updates (to update the Recent Posts feed)
            supabaseClient.channel('public:live_posts:cms').on('postgres_changes', { event: '*', schema: 'public', table: 'live_posts' }, (payload) => { 
                fetchRecentPosts(); 
            }).subscribe();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Content CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .content-block { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1.5rem; margin-top: 1.5rem; background-color: #f8fafc; position: relative; }
        .content-block h3 { font-size: 1rem; font-weight: 600; color: #475569; margin-bottom: 1rem; text-transform: uppercase; }
        .remove-block-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.2rem; }
        .remove-block-btn:hover { color: #ef4444; }
        .optional-desc-input::placeholder {
            color: #9ca3af; /* Faded black (gray-400) */
            font-style: italic;
        }
        textarea { resize: none; overflow: hidden; min-height: 50px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen py-8 md:py-12">

    <div id="app" class="w-full max-w-4xl mx-auto p-2 md:p-4">
        
        <div id="login-view" class="bg-white p-8 rounded-lg shadow-lg text-center max-w-md mx-auto">
            <h1 class="text-3xl font-bold mb-2">Live CMS Login</h1>
            <p class="text-slate-600 mb-6">Log in with GitHub to post live updates.</p>
            <button id="login-button" class="bg-slate-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 transition-colors flex items-center justify-center w-full max-w-xs mx-auto">
                <i class="fab fa-github mr-3"></i> Sign in with GitHub
            </button>
        </div>

        <div id="editor-view" class="hidden bg-white p-4 md:p-8 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl md:text-3xl font-bold">Create Live Update</h1>
                <button id="logout-button" class="text-sm text-slate-500 hover:text-slate-800">Logout</button>
            </div>
            
            <div id="content-blocks-container"></div>

            <div class="my-6 flex items-center gap-4 p-4 bg-slate-50 rounded-lg">
                 <select id="block-type-select" class="p-2 border border-slate-300 rounded-md">
                    <option value="content">Paragraph</option>
                    <option value="image">Image</option>
                    <option value="quote">Quote</option>
                    <option value="twitter">Twitter Embed</option>
                    <option value="instagram">Instagram Embed</option>
                 </select>
                 <button id="add-block-button" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors text-sm">
                    <i class="fas fa-plus mr-2"></i>Add Block
                </button>
            </div>
           
            <hr class="my-6">
            
            <div class="mb-6">
                <label for="article-tags" class="block text-sm font-medium text-slate-700 mb-1">Tags (Optional)</label>
                <input type="text" id="article-tags" class="w-full p-2 border border-slate-300 rounded-md" placeholder="e.g., politics, breaking, update (comma-separated)">
            </div>
            
            <button id="publish-button" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-500 transition-colors w-full flex items-center justify-center">
                <span id="publish-text">Publish Live Update</span>
                <span id="publish-spinner" class="hidden">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Publishing...
                </span>
            </button>
            <p id="status-message" class="text-center mt-4 text-sm"></p>
        </div>
    </div>

    <script>
        const GITHUB_CONFIG = {
            clientId: 'Ov23liQdWxdci4yccEie',
            redirectUri: 'https://www.tmpnews.com/auth-callback.html',
            repoOwner: 'AmmarKhanAlamgirOfficial',
            repoName: 'live-content',
            repoBranch: 'main',
            tokenExchangeUrl: 'https://github-auth-proxy.zaidkhan137782.workers.dev',
            articlesPath: ''
        };
        const loginView = document.getElementById('login-view'), editorView = document.getElementById('editor-view'), loginButton = document.getElementById('login-button'), logoutButton = document.getElementById('logout-button'), publishButton = document.getElementById('publish-button'), statusMessage = document.getElementById('status-message'), addBlockButton = document.getElementById('add-block-button'), blockTypeSelect = document.getElementById('block-type-select'), blocksContainer = document.getElementById('content-blocks-container');
        let accessToken = null;

        function autoExpand(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; }

        function createBlock(type) {
            const blockId = `block-${Date.now()}`;
            const blockWrapper = document.createElement('div');
            blockWrapper.className = 'content-block';
            blockWrapper.id = blockId;
            blockWrapper.dataset.blockType = type;
            let innerHTML = `<h3>${type.charAt(0).toUpperCase() + type.slice(1)}</h3><button class="remove-block-btn" onclick="document.getElementById('${blockId}').remove()">&times;</button>`;
            switch (type) {
                case 'headline': innerHTML += `<textarea rows="1" class="w-full p-2 border border-slate-300 rounded-md font-bold text-lg" placeholder="Main title of the update"></textarea>`; break;
                case 'content': innerHTML += `<textarea rows="5" class="w-full p-2 border border-slate-300 rounded-md" placeholder="Write the update details..."></textarea>`; break;
                case 'image': 
                    innerHTML += `<input type="text" class="url-input w-full p-2 border border-slate-300 rounded-md mb-2" placeholder="Paste any image link or markdown here">`;
                    innerHTML += `<input type="text" class="desc-input w-full p-2 border border-slate-300 rounded-md optional-desc-input" placeholder="Image description (optional)">`;
                    break;
                case 'quote': innerHTML += `<textarea rows="3" class="w-full p-2 border border-slate-300 rounded-md" placeholder="Enter the quote here..."></textarea>`; break;
                case 'twitter':
                case 'instagram':
                    innerHTML += `<textarea rows="4" class="url-input w-full p-2 border border-slate-300 rounded-md mb-2" placeholder="Paste the full embed code from ${type}"></textarea>`;
                    innerHTML += `<input type="text" class="desc-input w-full p-2 border border-slate-300 rounded-md optional-desc-input" placeholder="Description / Caption (optional)">`;
                    break;
            }
            blockWrapper.innerHTML = innerHTML;
            blocksContainer.appendChild(blockWrapper);
            blockWrapper.querySelectorAll('textarea').forEach(el => { el.addEventListener('input', () => autoExpand(el)); autoExpand(el); });
        }
        
        window.onload = async () => { /* ... existing unchanged onload logic ... */ };
        const showLogin = () => { /* ... existing unchanged showLogin logic ... */ };
        const showEditor = () => {
            loginView.classList.add('hidden'); editorView.classList.remove('hidden');
            if (blocksContainer.children.length === 0) { createBlock('headline'); createBlock('content'); }
        };
        loginButton.addEventListener('click', () => { /* ... existing unchanged login logic ... */ });
        logoutButton.addEventListener('click', async () => { /* ... existing unchanged logout logic ... */ });
        addBlockButton.addEventListener('click', () => createBlock(blockTypeSelect.value));

        publishButton.addEventListener('click', async () => {
            setPublishingState(true, 'Publishing...');

            function extractImageUrl(input) {
                const markdownUrlMatch = input.match(/\((https?:\/\/[^\s)]+)\)/);
                if (markdownUrlMatch && markdownUrlMatch[1]) return markdownUrlMatch[1];
                const plainUrlMatch = input.match(/https?:\/\/[^\s]+/);
                return plainUrlMatch ? plainUrlMatch[0] : null;
            }

            const blocks = Array.from(document.querySelectorAll('.content-block'));
            let headline = '', bodyParts = [];

            blocks.forEach(block => {
                const type = block.dataset.blockType;
                const urlInput = block.querySelector('.url-input');
                const descInput = block.querySelector('.desc-input');
                const mainInput = block.querySelector('textarea, input:not(.desc-input)');
                const value = mainInput?.value.trim();
                const descValue = descInput?.value.trim();
                if (!value) return;

                switch (type) {
                    case 'headline': headline = value; break;
                    case 'content': bodyParts.push(value); break;
                    case 'image':
                        const cleanUrl = extractImageUrl(value);
                        if (cleanUrl) bodyParts.push(`![${(descValue || 'Live update image').replace(/]/g, '')}](${cleanUrl})`);
                        break;
                    case 'quote': bodyParts.push(`> ${value.replace(/\n/g, '\n> ')}`); break;
                    case 'twitter':
                    case 'instagram':
                        if (descValue) bodyParts.push(`_${descValue}_`);
                        bodyParts.push(value);
                        break;
                }
            });

            const body = bodyParts.join('\n\n');
            if (!body && !headline) { /* ... existing empty check ... */ }
            const tags = document.getElementById('article-tags').value.trim();
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

            let frontmatter = `---\n`;
            if (headline) frontmatter += `headline: "${headline.replace(/"/g, '\\"')}"\n`;
            frontmatter += `timestamp: "${time}"\n`;
            if (tags) frontmatter += `tags: [${tags.split(',').map(tag => `"${tag.trim()}"`).join(', ')}]\n`;
            frontmatter += `authorName: "TMP Live Team"\n---\n\n`;

            const toBase64 = str => btoa(unescape(encodeURIComponent(str)));
            const fileContent = frontmatter + body;
            const encodedContent = toBase64(fileContent);
            const date = now.toISOString().split('T')[0];
            const timeForFile = now.toTimeString().split(' ')[0].replace(/:/g, '-');
            const filename = `${date}-${timeForFile}.md`;
            const filePath = GITHUB_CONFIG.articlesPath ? `${GITHUB_CONFIG.articlesPath}/${filename}` : filename;
            const commitMessage = `live: Add update for ${date} at ${time}`;
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.repoOwner}/${GITHUB_CONFIG.repoName}/contents/${filePath}`;

            try {
                const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${accessToken}`, 'Accept': 'application/vnd.github.v3+json' }, body: JSON.stringify({ message: commitMessage, content: encodedContent, branch: GITHUB_CONFIG.repoBranch }), });
                if (response.status === 201) {
                    updateStatus(`Successfully published: ${filename}`, 'green');
                    blocksContainer.innerHTML = '';
                    document.getElementById('article-tags').value = '';
                    showEditor();
                } else { const error = await response.json(); throw new Error(error.message || `GitHub API returned status ${response.status}`); }
            } catch (error) { updateStatus(`Error: ${error.message}`, 'red');
            } finally { setPublishingState(false, 'Publish Live Update'); }
        });
        
        // --- Helper functions remain the same ---
        const updateStatus=(e,t)=>{statusMessage.textContent=e,statusMessage.style.color=t,setTimeout(()=>statusMessage.textContent="",7e3)};const setPublishingState=(e,t)=>{publishButton.disabled=e,document.getElementById("publish-text").textContent=t,document.getElementById("publish-spinner").classList.toggle("hidden",!e)};window.onload=async()=>{const e=new URLSearchParams(window.location.search),t=e.get("code");if(t){window.history.pushState({},document.title,window.location.pathname);try{const e=await fetch(GITHUB_CONFIG.tokenExchangeUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t})}),o=await e.json();o.access_token?(accessToken=o.access_token,localStorage.setItem("githubLiveCmsToken",accessToken),showEditor()):(()=>{throw new Error(o.details||"Token exchange failed.")})()}catch(e){alert(`Authentication Failed: ${e.message}`),showLogin()}}else{const e=localStorage.getItem("githubLiveCmsToken");e?(accessToken=e,showEditor()):showLogin()}};
    </script>
</body>
</html>
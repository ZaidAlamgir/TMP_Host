<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Updates</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="menu.css">
    <link rel="stylesheet" href="login.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* --- New Animation for Posts --- */
        @keyframes newPostFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .new-post-animation {
            animation: newPostFadeIn 0.5s ease-out forwards;
        }

        /* Styles for Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1050; }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .modal-btn.primary { background: #0073e6; color: #fff; }
        .modal-btn.secondary { background: #e4e6eb; color: #050505; }
        .modal-btn.danger { background: #e42626; color: #fff; }

        /* --- Share Functionality Styles --- */
        .share-container { display: flex; align-items: center; }
        .social-links { display: flex; list-style: none; gap: 8px; margin-right: 8px; padding-left: 0; }
        .social-link { opacity: 0; transform: translateX(10px) scale(0.8); transition: all 0.3s ease-in-out; }
        .share-container.active .social-link { opacity: 1; transform: translateX(0) scale(1); }
        .social-link a { display: flex; justify-content: center; align-items: center; width: 32px; height: 32px; border-radius: 50%; color: #fff; text-decoration: none; }
        .social-link.facebook a { background-color: #1877F2; }
        .social-link.x-twitter a { background-color: #000000; }
        .social-link.whatsapp a { background-color: #25D366; }
        .social-link.instagram a { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); }
        .social-link.reddit a { background-color: #FF4500; }
        .social-link.copy-link a { background-color: #606770; }
        .share-btn-main { background: none; border: none; font-size: 1rem; color: #606770; cursor: pointer; padding: 5px; border-radius: 50%; width: 32px; height: 32px; transition: background-color 0.2s; position: relative; overflow: hidden;}
        .share-btn-main i { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .share-btn-main .close-icon { opacity: 0; transform: translate(-50%, -50%) rotate(180deg) scale(0.5); }
        .share-container.active .share-btn-main .share-icon { opacity: 0; transform: translate(-50%, -50%) rotate(-180deg) scale(0.5); }
        .share-container.active .share-btn-main .close-icon { opacity: 1; transform: translate(-50%, -50%) rotate(0deg) scale(1); }

        .post-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: #606770;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .post-actions button:hover {
            background-color: #f0f2f5;
        }
        .post-actions .edit-btn:hover {
            color: #0073e6;
        }
        .post-actions .delete-btn:hover {
            color: #e42626;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="header-placeholder"></div>

    <div id="admin-panel-container" class="max-w-3xl mx-auto px-4 pt-8" style="display: none;">
         <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-3">Live Admin Panel</h2>
            <form id="post-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="update-headline" class="block text-sm font-medium text-gray-700 mb-1">Headline (Optional)</label>
                        <input type="text" id="update-headline" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 font-bold text-lg" placeholder="e.g., Market Update">
                    </div>
                    <div>
                        <label for="image-url-1" class="block text-sm font-medium text-gray-700 mb-1">Image URL 1 (Optional)</label>
                        <input type="url" id="image-url-1" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" placeholder="https://example.com/image.jpg">
                    </div>
                </div>
                <div>
                    <label for="update-text-1" class="block text-sm font-medium text-gray-700 mb-1">Update Details 1 (Optional)</label>
                    <textarea id="update-text-1" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 font-medium" placeholder="First block of text..."></textarea>
                </div>
                <div>
                    <label for="image-url-2" class="block text-sm font-medium text-gray-700 mb-1">Image URL 2 (Optional)</label>
                    <input type="url" id="image-url-2" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" placeholder="https://example.com/image2.jpg">
                </div>
                <div>
                    <label for="update-text-2" class="block text-sm font-medium text-gray-700 mb-1">Update Details 2 (Optional)</label>
                    <textarea id="update-text-2" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 font-medium" placeholder="Second block of text..."></textarea>
                </div>
                <div>
                    <label for="image-url-3" class="block text-sm font-medium text-gray-700 mb-1">Image URL 3 (Optional)</label>
                    <input type="url" id="image-url-3" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" placeholder="https://example.com/image3.jpg">
                </div>
                <div>
                    <button type="submit" id="submit-button" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-md hover:bg-red-700">Post Live Update</button>
                </div>
            </form>
            <div id="feedback-message" class="mt-4 text-center"></div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 pb-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800">Live Coverage</h1>
            <p class="text-lg text-red-600 font-semibold mt-2 flex items-center justify-center">
                <span class="relative flex h-3 w-3 mr-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>LIVE
            </p>
        </header>

        <div id="live-feed" class="space-y-6">
            <div id="loading-indicator" class="text-center py-10"><p class="text-gray-500">Loading live updates...</p></div>
            <div id="empty-state" class="text-center py-10" style="display: none;"><p class="text-gray-500">No live updates yet.</p></div>
        </div>
        
        <div id="load-more-container" class="text-center mt-8" style="display: none;">
            <button id="load-more-btn" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-full hover:bg-gray-800">Load Previous Updates</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal-overlay"> <div class="modal-content"> <h3 class="text-xl font-bold mb-4">Edit Live Update</h3> <form id="edit-form" class="space-y-4 text-left"> <div> <label for="edit-headline" class="block text-sm font-medium text-gray-700 mb-1">Headline</label> <input type="text" id="edit-headline" class="w-full p-3 border border-gray-300 rounded-md font-bold text-lg"> </div> <div> <label for="edit-text" class="block text-sm font-medium text-gray-700 mb-1">Update Details</label> <textarea id="edit-text" rows="5" class="w-full p-3 border border-gray-300 rounded-md font-medium"></textarea> </div> </form> <div class="modal-actions"> <button id="cancelEditBtn" class="modal-btn secondary">Cancel</button> <button id="saveEditBtn" class="modal-btn primary">Save Changes</button> </div> </div> </div>
    <div id="deleteModal" class="modal-overlay"> <div class="modal-content"> <h3 class="text-xl font-bold mb-2">Delete Post</h3> <p class="text-gray-600">Are you sure you want to permanently delete this update?</p> <div class="modal-actions"> <button id="cancelDeleteBtn" class="modal-btn secondary">Cancel</button> <button id="confirmDeleteBtn" class="modal-btn danger">Delete</button> </div> </div> </div>

    <script src="firebase-init.js"></script>
    <script src="header-injector.js"></script>
    <script src="bottom-nav.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, query, onSnapshot, orderBy, getDocs, limit, startAfter, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAstYkSC7QMkZrjpYaTxvZyU_v6oPCDaAo",
            authDomain: "tmp-app-380a9.firebaseapp.com",
            projectId: "tmp-app-380a9",
            storageBucket: "tmp-app-380a9.firebasestorage.app",
            messagingSenderId: "1021013128440",
            appId: "1:1021013128440:web:a8f67c6b868b3ce5eff70d",
            measurementId: "G-LNEWEV2QN9"
        };
        const appId = "tmp-app-380a9";
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const adminPanel = document.getElementById('admin-panel-container');
        const postForm = document.getElementById('post-form');
        const feedContainer = document.getElementById('live-feed');
        const loadingIndicator = document.getElementById('loading-indicator');
        const emptyState = document.getElementById('empty-state');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const editModal = document.getElementById('editModal');
        const deleteModal = document.getElementById('deleteModal');

        let lastVisibleDoc = null;
        let isLoadingMore = false;
        let postToEditId = null;
        let postToDeleteId = null;
        let liveFeedUnsubscribe = null;
        
        onAuthStateChanged(auth, async (user) => {
            if (user && !user.isAnonymous) {
                const isAdmin = await checkAdminPermissions(user);
                adminPanel.style.display = isAdmin ? 'block' : 'none';
                if (isAdmin) {
                    setupFormListener(user);
                }
                initializeFeed(user);
            } else {
                adminPanel.style.display = 'none';
                initializeFeed(user); 
            }
        });

        async function checkAdminPermissions(user) {
            if (!user || user.isAnonymous) return false;
            const rolesDocRef = doc(db, "roles", user.uid);
            try {
                const rolesDoc = await getDoc(rolesDocRef);
                return rolesDoc.exists() && rolesDoc.data().isLiveAdmin === true;
            } catch (error) {
                console.error("Error checking admin permissions:", error);
                return false;
            }
        }

        function setupFormListener(user) {
            postForm.onsubmit = async (e) => {
                e.preventDefault();
                const submitButton = document.getElementById('submit-button');
                submitButton.disabled = true;
                
                const headline = document.getElementById('update-headline').value.trim();
                const imageUrl1 = document.getElementById('image-url-1').value.trim();
                const text1 = document.getElementById('update-text-1').value.trim();
                const imageUrl2 = document.getElementById('image-url-2').value.trim();
                const text2 = document.getElementById('update-text-2').value.trim();
                const imageUrl3 = document.getElementById('image-url-3').value.trim();

                const newUpdate = {
                    authorId: user.uid,
                    authorName: user.displayName || 'TMP Staff',
                    timestamp: serverTimestamp()
                };

                if (headline) newUpdate.headline = headline;
                if (imageUrl1) newUpdate.imageUrl1 = imageUrl1;
                if (text1) newUpdate.text1 = text1;
                if (imageUrl2) newUpdate.imageUrl2 = imageUrl2;
                if (text2) newUpdate.text2 = text2;
                if (imageUrl3) newUpdate.imageUrl3 = imageUrl3;

                // Only submit if there is at least one piece of content
                if (Object.keys(newUpdate).length > 3) {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/live_updates`), newUpdate);
                }
                
                postForm.reset();
                submitButton.disabled = false;
            };
        }

        function initializeFeed(user) {
            if (liveFeedUnsubscribe) liveFeedUnsubscribe(); 

            const updatesCollection = collection(db, `/artifacts/${appId}/public/data/live_updates`);
            const firstBatchQuery = query(updatesCollection, orderBy("timestamp", "desc"), limit(10));

            liveFeedUnsubscribe = onSnapshot(firstBatchQuery, (snapshot) => {
                loadingIndicator.style.display = 'none';
                const existingPostIds = new Set(Array.from(feedContainer.children).map(el => el.dataset.postId));
                
                const postsHtml = snapshot.docs.map((doc, index) => {
                    const isNew = index === 0 && !existingPostIds.has(doc.id) && existingPostIds.size > 0;
                    return createUpdateElement(doc.data(), doc.id, user, isNew);
                }).join('');
                
                feedContainer.innerHTML = postsHtml;

                if (snapshot.empty) {
                    emptyState.style.display = 'block';
                    loadMoreContainer.style.display = 'none';
                } else {
                     emptyState.style.display = 'none';
                }

                lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                checkIfMoreDocsExist();
            });
        }
        
        loadMoreBtn.addEventListener('click', async () => {
            if (isLoadingMore || !lastVisibleDoc) return;
            isLoadingMore = true;
            loadMoreBtn.textContent = "Loading...";
            
            const user = auth.currentUser;
            const updatesCollection = collection(db, `/artifacts/${appId}/public/data/live_updates`);
            const nextBatchQuery = query(updatesCollection, orderBy("timestamp", "desc"), startAfter(lastVisibleDoc), limit(5));
            
            const snapshot = await getDocs(nextBatchQuery);
            if (!snapshot.empty) {
                 snapshot.docs.forEach(doc => {
                    const postElement = document.createElement('div');
                    postElement.innerHTML = createUpdateElement(doc.data(), doc.id, user, false);
                    feedContainer.appendChild(postElement.firstChild);
                });
                lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
                await checkIfMoreDocsExist();
            } else {
                loadMoreContainer.style.display = 'none';
            }
            isLoadingMore = false;
            loadMoreBtn.textContent = "Load Previous Updates";
        });

        async function checkIfMoreDocsExist() {
             if (!lastVisibleDoc) { 
                loadMoreContainer.style.display = 'none';
                return; 
             }
             const updatesCollection = collection(db, `/artifacts/${appId}/public/data/live_updates`);
             const nextDocQuery = query(updatesCollection, orderBy("timestamp", "desc"), startAfter(lastVisibleDoc), limit(1));
             const snapshot = await getDocs(nextDocQuery);
             loadMoreContainer.style.display = snapshot.empty ? 'none' : 'block';
        }

        function generateColorForUser(userId) {
            const colors = ['#e53935', '#d81b60', '#8e24aa', '#5e35b1', '#3949ab', '#1e88e5', '#039be5', '#00acc1', '#00897b', '#43a047', '#fb8c00', '#f4511e', '#6d4c41', '#546e7a'];
            if (!userId) return colors[0];
            let hash = 0;
            for (let i = 0; i < userId.length; i++) hash = ((hash << 5) - hash) + userId.charCodeAt(i);
            return colors[Math.abs(hash % colors.length)];
        }

        function createUpdateElement(update, postId, user, isNew) { 
            const animationClass = isNew ? 'new-post-animation' : '';
            const containerClasses = `bg-white rounded-lg shadow-lg overflow-hidden p-6 border-l-4 border-red-600 ${animationClass}`;
            
            let adminActions = '';
            if (user && !user.isAnonymous && user.uid === update.authorId) {
                adminActions = `
                    <div class="post-actions flex gap-2">
                        <button class="edit-btn" title="Edit Post"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn" title="Delete Post"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
            }

            const xIconSVG = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"><path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.6.75Zm-.86 13.028h1.36L4.323 2.145H2.865l8.875 11.633Z"/></svg>`;
            const shareContainerHTML = `<div class="share-container"> ... </div>`; // For brevity
            
            const authorInitial = (update.authorName || 'A').charAt(0).toUpperCase();
            const avatarColor = generateColorForUser(update.authorId);
            const authorInfoTemplate = (marginClass) => `
                <div class="flex items-center gap-2 ${marginClass}">
                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-white font-bold text-xs flex-shrink-0" style="background-color: ${avatarColor};">${authorInitial}</div>
                    <div class="font-semibold text-sm text-gray-700">${escapeHTML(update.authorName) || 'TMP Staff'}</div>
                </div>
            `;
            
            const headlineHTML = update.headline ? `<h3 class="text-2xl font-bold text-gray-900 mb-2">${escapeHTML(update.headline)}</h3>` : '';
            const image1HTML = update.imageUrl1 ? `<img src="${update.imageUrl1}" class="w-full h-auto object-cover rounded-lg mt-4">` : '';
            const text1HTML = update.text1 ? `<p class="text-gray-800 text-base font-medium leading-relaxed whitespace-pre-wrap mt-4 update-text-1">${escapeHTML(update.text1)}</p>` : '';
            const image2HTML = update.imageUrl2 ? `<img src="${update.imageUrl2}" class="w-full h-auto object-cover rounded-lg mt-4">` : '';
            const text2HTML = update.text2 ? `<p class="text-gray-800 text-base font-medium leading-relaxed whitespace-pre-wrap mt-4 update-text-2">${escapeHTML(update.text2)}</p>` : '';
            const image3HTML = update.imageUrl3 ? `<img src="${update.imageUrl3}" class="w-full h-auto object-cover rounded-lg mt-4">` : '';

            let mainContentHTML = '';
            let authorPlacementHTML = '';

            if (update.headline) {
                mainContentHTML = `${headlineHTML}${authorInfoTemplate('mb-4')}${image1HTML}${text1HTML}${image2HTML}${text2HTML}${image3HTML}`;
            } else {
                mainContentHTML = `${image1HTML}${text1HTML}${image2HTML}${text2HTML}${image3HTML}`;
                authorPlacementHTML = authorInfoTemplate('mt-4');
            }

            const formattedTime = update.timestamp ? new Date(update.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

            return `
                <div class="${containerClasses}" data-post-id="${postId}">
                    <div class="post-content">${mainContentHTML}</div>
                    ${authorPlacementHTML}
                    <div class="post-footer flex justify-between items-center border-t border-gray-200 pt-3 mt-4">
                        <div class="flex-1 min-w-0">${adminActions}</div>
                        <div class="flex-shrink-0 text-sm font-semibold text-gray-500 px-2 sm:px-4">${formattedTime}</div>
                        <div class="flex-1 min-w-0 flex justify-end">${shareContainerHTML}</div>
                    </div>
                </div>
            `;
        }

        feedContainer.addEventListener('click', (e) => {
            const postElement = e.target.closest('[data-post-id]');
            if (!postElement) return;

            if (e.target.closest('.edit-btn')) {
                postToEditId = postElement.dataset.postId;
                const headlineElement = postElement.querySelector('h3');
                const text1Element = postElement.querySelector('.update-text-1');
                document.getElementById('edit-headline').value = headlineElement ? headlineElement.textContent : '';
                document.getElementById('edit-text').value = text1Element ? text1Element.textContent : '';
                editModal.style.display = 'flex';
            }
            if (e.target.closest('.delete-btn')) {
                postToDeleteId = postElement.dataset.postId;
                deleteModal.style.display = 'flex';
            }
            // ... share logic ...
        });

        document.getElementById('cancelEditBtn').onclick = () => editModal.style.display = 'none';
        document.getElementById('cancelDeleteBtn').onclick = () => deleteModal.style.display = 'none';

        document.getElementById('saveEditBtn').onclick = async () => {
            if (!postToEditId) return;
            const postRef = doc(db, `/artifacts/${appId}/public/data/live_updates`, postToEditId);
            await updateDoc(postRef, { 
                headline: document.getElementById('edit-headline').value.trim(), 
                text1: document.getElementById('edit-text').value.trim() 
            });
            editModal.style.display = 'none';
            postToEditId = null;
        };
        
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (!postToDeleteId) return;
            const postRef = doc(db, `/artifacts/${appId}/public/data/live_updates`, postToDeleteId);
            await deleteDoc(postRef);
            deleteModal.style.display = 'none';
            postToDeleteId = null;
        };
        
        function escapeHTML(str) {
            if (!str) return '';
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }
    </script>
</body>
</html>

